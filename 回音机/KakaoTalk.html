<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KakaoTalk</title>
<style>
:root {
    --iphone-width: 393px;
    --iphone-height: 852px;
    --iphone-radius: 55px;
    --screen-radius: 47px;
    --island-width: 120px;
    --island-height: 36px;
    --island-radius: 16px;
    --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
    
    --kakao-yellow: #fee500;
    --kakao-brown: #3c1e1e;
    --gray-bg: #ffffff;
    --active-tab: #000;
    --inactive-tab: #d1d1d6;
    --danger: #ff3b30;
    
    --msg-bg-me: #fee500;
    --msg-color-me: #000000;
    --msg-bg-other: #ffffff;
    --msg-color-other: #000000;
    --chat-bg: #aec5eb;
    --real-chat-bg: var(--chat-bg);
}

* { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; outline: none; }
body {
    background-color: #e0e0e0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    font-family: var(--ios-font);
    overflow: hidden;
}

/* Screen */
.screen {
    width: var(--iphone-width);
    height: var(--iphone-height);
    background: #fff;
    border-radius: var(--screen-radius);
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.05);
    display: flex; flex-direction: column;
}

/* 手机外壳 */
.iphone-body {
    width: calc(var(--iphone-width) + 12px);
    height: calc(var(--iphone-height) + 12px);
    background: #fff;
    border: 2px solid #d1d1d6;
    border-radius: var(--iphone-radius);
    padding: 6px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.1);
    position: relative;
    display: flex; justify-content: center; align-items: center;
    transform-origin: center;
}


/* 状态栏 & 灵动岛 */
.dynamic-island {
    width: var(--island-width); height: var(--island-height);
    background: #000; border-radius: var(--island-radius);
    position: absolute; top: 11px; left: 50%; transform: translateX(-50%);
    z-index: 9999;
}
.status-bar {
    height: 54px; padding: 0 28px 6px;
    display: flex; justify-content: space-between; align-items: flex-end;
    font-size: 16px; font-weight: 600; color: #000;
    z-index: 9000;
    background: transparent;
    pointer-events: none;
}
.status-right { display: flex; align-items: center; gap: 6px; }
.battery-container { display: flex; align-items: center; }
.battery-body {
    width: 24.5px; height: 11.5px;
    border: 1px solid #000; border-radius: 4px;
    padding: 1px; display: flex; position: relative;
}
.battery-body::after {
    content: ''; position: absolute; right: -3.5px; top: 50%; transform: translateY(-50%);
    width: 2px; height: 4px; background: #000; border-radius: 0 1px 1px 0;
}
.battery-fill { height: 100%; width: 60%; background: #000; border-radius: 1px; }

/* 头部 */
.app-header {
    height: 50px; padding: 0 20px;
    display: flex; justify-content: space-between; align-items: center;
    background: #fff; z-index: 100; flex-shrink: 0;
}
.header-title { font-size: 22px; font-weight: 700; color: #000; }
.header-actions { display: flex; gap: 20px; align-items: center; }
.header-btn { width: 24px; height: 24px; cursor: pointer; stroke: #000; fill: none; stroke-width: 1.5; color: #000; }
.icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

/* 视图容器包裹层 */
.main-view-wrapper {
    flex: 1;
    position: relative;
    width: 100%;
    overflow: hidden;
    z-index: 1;
}

/* 视图容器 */
.view-container {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto;
    padding-bottom: 95px; /* 底部导航高度 */
    
    opacity: 0;
    pointer-events: none;
    
    background: #fff; /* 默认背景白 */
    z-index: 10;
}
.view-container.active { 
    opacity: 1; 
    pointer-events: auto; 
    z-index: 20;
}
.view-container::-webkit-scrollbar { display: none; }

/* 聊天分组栏 */
.chat-group-bar {
    display: flex;
    overflow-x: auto;
    padding: 10px 15px;
    gap: 8px;
    background: #fff;
    border-bottom: 1px solid #f0f0f0;
    scrollbar-width: none; 
    position: relative;
    z-index: 10;
}
.chat-group-bar::-webkit-scrollbar { display: none; }

.chat-group-pill {
    padding: 6px 14px;
    border-radius: 16px;
    font-size: 13px;
    color: #666;
    background: #fff;
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid #eee;
}

.chat-group-pill.active {
    background: var(--kakao-brown);
    color: var(--kakao-yellow);
    font-weight: 600;
}

/* 列表项 */
.profile-item {
    padding: 12px 20px; display: flex; align-items: center; gap: 15px;
    cursor: pointer; transition: background 0.2s;
}
.profile-item:active { background: #f5f5f5; }
.avatar { width: 44px; height: 44px; border-radius: 18px; object-fit: cover; background: #eee; flex-shrink: 0; }
.avatar.lg { width: 56px; height: 56px; border-radius: 22px; }
.profile-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
.profile-name { font-size: 16px; font-weight: 600; color: #000; margin-bottom: 2px; }
.profile-status { font-size: 12px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.section-title {
    font-size: 12px; color: #999; padding: 15px 20px 5px; margin-top: 5px; border-top: 1px solid #f9f9f9;
}

/* 更多页面 */
#view-more { background: var(--gray-bg); }
.more-view-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
.more-title { font-size: 24px; font-weight: 700; }
.more-profile { padding: 10px 20px; display: flex; align-items: center; gap: 15px; cursor: pointer; }
.pay-card {
    margin: 15px 20px; background: var(--kakao-yellow); border-radius: 12px; padding: 15px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(254, 229, 0, 0.2);
}
.pay-top { display: flex; justify-content: space-between; align-items: center; }
.pay-amount { display: flex; flex-direction: column; }
.pay-amount strong { font-size: 13px; color: #333; margin-bottom: 2px; }
.pay-amount span { font-size: 18px; font-weight: 700; }
.pay-btn { background: #fff; padding: 6px 12px; border-radius: 14px; font-size: 12px; font-weight: 500; color: #666; }

/* 钱包卡片 (Yellow Card) */
.wallet-card-lg {
    margin: 20px; 
    background: var(--kakao-yellow); 
    border-radius: 24px; 
    padding: 25px 20px;
    cursor: pointer; 
    box-shadow: 0 5px 15px rgba(254, 229, 0, 0.3);
    display: flex; flex-direction: column; gap: 10px; height: 180px; justify-content: space-between;
}

.wallet-actions { display: flex; justify-content: space-around; padding: 30px 20px; }

.section-header { padding: 20px 20px 10px; font-size: 14px; font-weight: 600; color: #000; }
.services-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px 0; padding: 0 10px;
}
.service-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
.svc-icon-box { width: 50px; height: 50px; border-radius: 20px; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; }
.svc-icon { width: 28px; height: 28px; stroke: #666; stroke-width: 1.5; fill: none; }
.service-label { font-size: 11px; color: #333; text-align: center; }

/* 底部导航 */
.bottom-nav {
    position: absolute; bottom: 0; width: 100%; height: 95px;
    background: #fff; border-top: 1px solid #e0e0e0;
    display: flex; justify-content: space-around; padding-top: 15px;
    padding-bottom: 15px;
    z-index: 500;
}
.home-indicator {
    position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
    width: 120px; height: 5px; background: #000; border-radius: 3px; opacity: 0.3;
    z-index: 9999; cursor: pointer;
}
.nav-btn { cursor: pointer; color: var(--inactive-tab); display: flex; flex-direction: column; align-items: center; }
.nav-btn.active { color: var(--active-tab); }
.nav-btn svg { width: 26px; height: 26px; stroke: currentColor; fill: currentColor; stroke-width: 0; }
.nav-btn.active svg { fill: currentColor; }
.nav-btn svg path, .nav-btn svg circle, .nav-btn svg rect, .nav-btn svg line { stroke: currentColor; stroke-width: 2; fill: none; }
.nav-btn.active svg path, .nav-btn.active svg circle, .nav-btn.active svg rect { fill: currentColor; }

/* 模态框 */
.modal {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 2000; display: flex; flex-direction: column;
    padding-top: 54px; /* 避开状态栏 */
    opacity: 0;
    pointer-events: none;
    transform: scale(0.95);
    transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    visibility: hidden;
}

.wallet-view {
    background: var(--gray-bg) !important;
}
.modal.active { 
    opacity: 1; 
    pointer-events: auto; 
    transform: scale(1);
    visibility: visible;
}
.modal > div::-webkit-scrollbar { display: none; }
.modal > div { -ms-overflow-style: none; scrollbar-width: none; }

.theme-section { margin-bottom: 25px; padding: 0 20px; }
.theme-label { font-size: 13px; color: #666; margin-bottom: 8px; font-weight: 500; }
.theme-row { display: flex; flex-direction: column; gap: 8px; }
.theme-card {
    background: #fff; padding: 15px 20px; border-radius: 12px;
    display: flex; flex-direction: row; align-items: center; justify-content: space-between;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02); cursor: pointer;
}
.theme-card span { font-size: 15px; color: #333; }
.theme-card input[type="color"] { width: 40px; height: 40px; border: none; padding: 0; }

/* 主题预览 */
.preview-box {
    margin: 10px auto; width: 240px; height: 180px;
    border-radius: 20px; overflow: hidden; border: none;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}
.preview-chat-bg {
    width: 100%; height: 100%; background: #aec5eb;
    display: flex; flex-direction: column; justify-content: center; padding: 15px; gap: 10px;
}

/* 输入控件 */
.group-title { font-size: 13px; color: #666; padding: 20px 20px 8px; text-transform: uppercase; }
.group-card { background: #fff; border-radius: 12px; margin: 0 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.group-item {
    padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 15px;
}
.group-item:last-child { border-bottom: none; }
input[type="color"] {
    -webkit-appearance: none; border: none; width: 30px; height: 30px;
    border-radius: 50%; overflow: hidden; cursor: pointer; padding: 0;
}
input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }

/* Profile View (Immersive) */
.profile-view {
    background-color: #545b66;
    color: #fff;
    background-size: cover; background-position: center;
    z-index: 5000;
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    pointer-events: none;
    transform: translateY(100%);
    transition: opacity 0.3s, transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.profile-view.active { 
    opacity: 1; 
    pointer-events: auto; 
    transform: translateY(0);
}
.profile-overlay { display: none; }
.profile-content {
    position: relative; z-index: 10; height: 100%;
    display: flex; flex-direction: column;
}
.pf-top {
    height: 60px; padding: 0 20px;
    display: flex; justify-content: space-between; align-items: flex-start;
    padding-top: 15px;
}
.pf-top svg { width: 24px; height: 24px; stroke: #fff; stroke-width: 1.5; }

.pf-main {
    display: flex; flex-direction: column;
    justify-content: flex-start; align-items: flex-start;
    margin-top: 240px;
    padding-left: 30px;
    padding-right: 30px;
    width: 100%;
}
.pf-avatar-lg {
    width: 80px; height: 80px; border-radius: 32px;
    object-fit: cover; margin-bottom: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    cursor: pointer;
}
.pf-name { font-size: 18px; font-weight: 600; margin-bottom: 6px; text-shadow: 0 1px 3px rgba(0,0,0,0.3); width: 100%; text-align: left; }
.pf-status { font-size: 13px; opacity: 0.8; margin-bottom: 30px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); width: 100%; text-align: left; }

/* Edit Mode Styles */
.edit-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    width: 100%;
}
.edit-input {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 16px;
    width: 100%;
    text-align: left;
}
.edit-input::placeholder {
    color: rgba(255,255,255,0.5);
}
.edit-icon {
    width: 16px; height: 16px;
    color: rgba(255,255,255,0.8);
    flex-shrink: 0;
    margin-left: 10px;
}

.pf-footer {
    padding: 0 20px;
    margin-top: 20px;
    margin-bottom: 40px;
    width: 100%;
    flex: none;
}

.pf-action-box {
    display: flex; align-items: center;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    height: 60px;
    width: 100%;
    background: rgba(255,255,255,0.25);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.pf-box-btn {
    flex: 1; display: flex; justify-content: center; align-items: center; gap: 8px;
    font-size: 15px; color: #fff; cursor: pointer; height: 100%;
}
.pf-box-btn:active { background: rgba(255,255,255,0.1); }

.pf-box-sep {
    width: 1px; height: 24px; background: rgba(255,255,255,0.3);
}

.pf-action { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; color: #fff; }
.pf-icon-circle {
    width: 50px; height: 50px; border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.3);
    display: flex; align-items: center; justify-content: center;
    background: transparent;
}
.pf-action span { font-size: 11px; opacity: 0.9; }

/* Drawers */
.drawer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 2500;
    padding-top: 54px; /* 避开状态栏 */
    display: flex; flex-direction: column;
    pointer-events: none;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.drawer.active { 
    pointer-events: auto; 
    transform: translateX(0);
}
.drawer-header {
    height: 50px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between;
    font-size: 16px; font-weight: 600; background: #fff;
}
.drawer-content { flex: 1; overflow-y: auto; padding: 20px 0; }

.gal-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px;
}
.gal-item {
    aspect-ratio: 1; background: #ddd; object-fit: cover;
}

/* Editors */
.editor-modal { background: #fff; }
.editor-form { padding: 20px; flex: 1; overflow-y: auto; }
.editor-row { margin-bottom: 20px; }
.editor-label { display: block; font-size: 12px; color: #666; margin-bottom: 6px; margin-left: 4px; }
.editor-input {
    width: 100%; padding: 15px; border: none; 
    font-size: 16px; border-radius: 12px; background: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
.editor-input:focus { outline: 2px solid var(--kakao-yellow); }
textarea.editor-input { height: 120px; resize: none; }

/* Chat Room */
.chat-room {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--real-chat-bg); z-index: 3000;
    display: flex; flex-direction: column;
    padding-top: 0;
    pointer-events: none;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.chat-room.active { 
    pointer-events: auto; 
    transform: translateX(0);
}
.chat-room .app-header {
    height: 100px !important;
    padding-top: 54px !important;
    align-items: flex-start;
}
.chat-room .app-header .header-btn, 
.chat-room .app-header .header-title {
    margin-top: 5px;
}

.chat-msgs { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.msg-row { 
    display: flex; 
    align-items: flex-start; 
    gap: 8px; 
    max-width: 85%; 
    margin-bottom: 5px;
}
.msg-row.mine { 
    align-self: flex-end; 
    flex-direction: row-reverse; 
}

/* 消息内容容器：包含气泡和元数据 */
.msg-content-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 4px;
    max-width: 100%;
}
.msg-row.mine .msg-content-wrapper {
    flex-direction: row-reverse;
}

/* 元数据：时间与未读 */
.msg-meta {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: flex-start;
    min-width: fit-content;
    margin-bottom: 0;
}
.msg-row.mine .msg-meta {
    align-items: flex-end;
}

.msg-unread {
    color: #d6c000; /* Kakao Yellow darker */
    font-size: 10px;
    font-weight: bold;
    margin-bottom: 2px;
}

.msg-reasoning {
    font-size: 12px;
    color: #666;
    background: rgba(0,0,0,0.05);
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 4px;
    white-space: pre-wrap;
    border-left: 2px solid #ccc;
    max-width: 100%;
}
.msg-time {
    font-size: 10px;
    color: #555;
    white-space: nowrap;
}

.msg-bubble {
    padding: 8px 12px; border-radius: 12px; font-size: 14px; line-height: 1.4;
    word-wrap: break-word; position: relative;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    max-width: 100%;
}
.msg-row:not(.mine) .msg-bubble { background: #fff; color: #000; border-top-left-radius: 2px; }
.msg-row.mine .msg-bubble { background: #fee500; color: #000; border-top-right-radius: 2px; }

.msg-row.blocked::after {
    content: '!';
    display: flex; align-items: center; justify-content: center;
    width: 20px; height: 20px; border-radius: 50%;
    background: #ff3b30; color: #fff; font-size: 14px; font-weight: bold;
    margin-top: 10px; flex-shrink: 0;
}

.msg-row:not(.mine) .msg-bubble {
    background: var(--msg-bg-other); color: var(--msg-color-other);
    background-size: cover; background-position: center;
}
.msg-row.mine .msg-bubble {
    background: var(--msg-bg-me); color: var(--msg-color-me);
    background-size: cover; background-position: center;
}

/* 正在输入指示器 */
.typing-indicator {
    display: none;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    background: #fff;
    border-radius: 12px;
    border-top-left-radius: 2px;
    align-self: flex-start;
    margin-left: 44px; /* 避开头像位置 */
    margin-bottom: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    width: fit-content;
}
.typing-dot {
    width: 4px;
    height: 4px;
    background: #888;
    border-radius: 50%;
    animation: typing-blink 1.4s infinite both;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing-blink {
    0%, 80%, 100% { opacity: 0.2; }
    40% { opacity: 1; }
}

.chat-footer {
    min-height: 50px; background: #fff; padding: 8px 10px 25px 10px;
    display: flex; align-items: center; gap: 10px; z-index: 3010;
}
.chat-input {
    flex: 1; background: #fff; border: 1px solid #eee; padding: 8px 12px;
    border-radius: 18px; font-size: 14px; max-height: 80px;
}
.chat-extra {
    height: 0; overflow: hidden; background: #fff; transition: height 0.2s;
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
}
.chat-extra.open { height: 200px; padding: 20px; border-top: 1px solid #f0f0f0; }

/* Chat Settings Page (Kakao Style) */
.chat-settings-page {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; z-index: 3050;
    display: flex; flex-direction: column;
    padding-top: 0;
    pointer-events: none;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.chat-settings-page.active { 
    pointer-events: auto; 
    transform: translateX(0);
}

.chat-settings-page .app-header, .sub-page .app-header {
    padding-top: 44px;
    height: 90px;
    align-items: center;
    background: #fff;
    border-bottom: 1px solid #f0f0f0;
}
.chat-settings-page .header-title, .sub-page .header-title {
    margin-top: 10px;
}
.chat-settings-page .header-btn, .sub-page .header-btn {
    margin-top: 10px;
}

.chat-settings-content {
    flex: 1; overflow-y: auto; padding: 0;
    -ms-overflow-style: none; scrollbar-width: none; 
}
.chat-settings-content::-webkit-scrollbar { display: none; }

.cs-section {
    background: #fff; border-bottom: 8px solid #f5f5f5;
}
.cs-section:last-child { border-bottom: none; }
.cs-section-header {
    padding: 12px 20px 8px; font-size: 12px; color: #888; font-weight: 600;
}

.cs-row {
    padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #f5f5f5; cursor: pointer;
    font-size: 15px; color: #1e1e1e;
}
.cs-row:active { background: #f9f9f9; }
.cs-row:last-child { border-bottom: none; }
.cs-row.danger { color: #3c1e1e; opacity: 0.8; justify-content: flex-start; }

/* New Chat Settings Layout (Refined) */
.cs-content { 
    padding: 0 0 40px 0; 
    overflow-y: auto; 
    flex: 1; 
    background: #fff; 
    scrollbar-width: none; /* Firefox */
}
.cs-content::-webkit-scrollbar { display: none; } /* Chrome/Safari */

.cs-top-profile {
    background: transparent; padding: 30px 20px 20px;
    display: flex; flex-direction: column; align-items: center;
    border-bottom: none; margin-bottom: 10px;
}
.cs-avatar-lg {
    width: 92px; height: 92px; border-radius: 38px; object-fit: cover; 
    margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); cursor: pointer;
    border: 1px solid rgba(0,0,0,0.05);
}
.cs-name-lg { font-size: 20px; font-weight: 700; color: #000; margin-bottom: 4px; }
.cs-desc { font-size: 13px; color: #8e8e93; }

/* List Cards */
.cs-card { 
    background: #fff; 
    margin: 0 16px 16px 16px; 
    border-radius: 14px; 
    overflow: hidden; 
    box-shadow: none;
}
.cs-list-item {
    display: flex; align-items: center; padding: 12px 20px;
    cursor: pointer;
    height: 48px;
    position: relative;
    background: #fff;
    transition: background 0.2s;
}
.cs-list-item:active { background: #f2f2f7; }

.cs-list-icon {
    width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    margin-right: 12px; flex-shrink: 0;
    background: transparent;
}
.cs-list-icon svg { width: 22px; height: 22px; stroke: #000; stroke-width: 1.3; fill: none; }
.cs-list-text { flex: 1; font-size: 14px; color: #000; font-weight: 400; }

/* Summary Board (Vertical List Style) */
.cs-sb-header {
    padding: 15px 20px 10px; font-size: 13px; color: #6d6d72; font-weight: 400;
    margin-left: 16px; text-transform: uppercase;
}

/* Participants */
.cs-part-header {
    padding: 15px 20px; font-size: 15px; font-weight: 600; color: #000;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid #e5e5ea;
    background: #fff;
}
.cs-part-list { padding: 0; background: #fff; }
.cs-part-row {
    padding: 8px 20px; display: flex; align-items: center; gap: 10px;
    cursor: pointer; border-bottom: none;
}
.cs-part-row:last-child { border-bottom: none; }
.cs-part-row:active { background: #f9f9f9; }
.cs-part-avatar {
    width: 40px; height: 40px; border-radius: 16px; object-fit: cover;
}
.cs-part-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
.cs-part-name { font-size: 16px; font-weight: 500; color: #000; display: flex; align-items: center; gap: 6px; }
.cs-me-badge { 
    font-size: 5px; background: #4a4a4a; color: #fff; 
    width: 18px; height: 18px; border-radius: 50%; 
    display: inline-flex; align-items: center; justify-content: center;
    margin-right: 6px; font-weight: bold; flex-shrink: 0;
}
.cs-part-status { font-size: 12px; color: #8e8e93; margin-top: 2px; }

/* Sub Page */
.sub-page {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #fff; /* Default light gray for subpages */
    z-index: 4000;
    display: flex; flex-direction: column;
    padding-top: 0;
    pointer-events: none;
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
}
.sub-page.active { 
    pointer-events: auto; 
    transform: translateX(0);
}
.sub-page-content { 
    flex: 1; overflow-y: auto; position: relative; 
    -ms-overflow-style: none; scrollbar-width: none; 
}
.sub-page-content::-webkit-scrollbar { display: none; }

.cs-avatar { width: 50px; height: 50px; border-radius: 20px; object-fit: cover; margin-right: 15px; }
.cs-user-info { flex: 1; display: flex; flex-direction: column; }
.cs-name { font-size: 17px; font-weight: 600; }
.cs-status { font-size: 12px; color: #888; margin-top: 2px; }

.cs-gallery-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px;
    padding: 10px 20px 20px;
}
.cs-gallery-item {
    aspect-ratio: 1; background: #eee; object-fit: cover; cursor: pointer;
}
.cs-gallery-item:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
.cs-gallery-item:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

.calendar-widget { padding: 10px 20px 20px; }
.cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.cal-title { font-weight: 600; font-size: 15px; }
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 13px; gap: 8px 0; }
.cal-day-name { color: #999; font-size: 11px; margin-bottom: 5px; }
.cal-day { width: 30px; height: 30px; line-height: 30px; margin: 0 auto; border-radius: 50%; }
.cal-day.active { background: #fee500; font-weight: bold; }
.cal-day.today { border: 1px solid #ccc; }

.sch-list { padding: 0 20px 15px; }
.sch-item { display: flex; gap: 15px; margin-bottom: 15px; }
.sch-time { width: 40px; font-size: 12px; color: #999; text-align: right; padding-top: 2px; }
.sch-content { flex: 1; font-size: 15px; border-bottom: 1px solid #f5f5f5; padding-bottom: 15px; }

.sch-nav {
    display: flex; justify-content: center; align-items: center; gap: 20px;
    padding: 15px; background: #fff; border-bottom: 1px solid #f0f0f0;
}
.sch-nav-btn {
    border: none; background: transparent; font-size: 24px; color: #3c1e1e; cursor: pointer; padding: 0 10px;
}
.sch-nav-date {
    font-size: 16px; font-weight: 600; color: #3c1e1e;
}

.timeline-list { padding: 25px 20px; }
.timeline-item { position: relative; padding-left: 24px; margin-bottom: 30px; border-left: 1px solid #e0e0e0; }
.timeline-item::before {
    content: ''; position: absolute; left: -5px; top: 4px;
    width: 9px; height: 9px; border-radius: 50%; 
    background: #fff; border: 2px solid #3c1e1e;
}
.timeline-date { font-size: 13px; font-weight: 600; color: #3c1e1e; margin-bottom: 4px; }
.timeline-title { font-size: 15px; color: #555; line-height: 1.5; }

.calendar-full { padding: 20px; background: #fff; border-bottom: 8px solid #f5f5f5; }
.cal-day.active { background: transparent; border: 2px solid #fee500; font-weight: bold; color: #000; }
.cal-day.today { background: #f0f0f0; border: none; }

.anniversary-list { padding-bottom: 40px; }
.ann-item {
    padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px;
}
.ann-icon { width: 40px; height: 40px; background: #fee500; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
.ann-info { flex: 1; }
.ann-title { font-weight: 600; font-size: 15px; }
.ann-date { font-size: 12px; color: #888; }

.btn-sm { padding: 6px 12px; border: 1px solid #ddd; background: #fff; border-radius: 14px; font-size: 12px; cursor: pointer; }

.switch { position: relative; display: inline-block; width: 50px; height: 28px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e5ea; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 24px; width: 24px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
input:checked + .slider { background-color: #fee500; }
input:checked + .slider:before { transform: translateX(22px); }

.mask-list { display: flex; flex-direction: column; padding: 0 20px; gap: 12px; }
.mask-item {
    display: flex; align-items: center; gap: 15px; padding: 15px;
    background: #fff; border-radius: 12px; border-bottom: none; cursor: pointer;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
.mask-item.active { border: 2px solid var(--kakao-yellow); }
.mask-item.active .avatar { border: none; }
.mask-add {
    margin-top: 5px; padding: 15px; background: #fff; border-radius: 12px;
    text-align: center; color: #333; cursor: pointer; font-weight: 500;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}
.mask-add span { font-size: 18px; font-weight: 300; }

/* Gift Styles */
.gift-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 10px; }
.gift-item { background: #fff; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
.gift-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
.gift-name { font-size: 14px; font-weight: 600; color: #333; }
.gift-price { font-size: 13px; color: #888; }

.msg-gift-card {
    background: #fff; border-radius: 12px; overflow: hidden; width: 220px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    padding: 12px;
    display: flex; flex-direction: column;
}
.msg-gift-img { width: 100%; height: 140px; object-fit: cover; background: #eee; border-radius: 8px; margin-bottom: 10px; }
.msg-gift-tag { display: inline-block; padding: 2px 6px; background: #fee500; border-radius: 4px; font-size: 10px; font-weight: bold; color: #3c1e1e; margin-bottom: 5px; align-self: flex-start; }
.msg-gift-btn { margin-top: 10px; width: 100%; padding: 8px; background: #fff; border: 1px solid #eee; text-align: center; font-size: 12px; font-weight: 600; color: #333; border-radius: 6px; cursor: pointer; }

/* Group Manager Page Specific Styles */
#groupManagerPage .app-header, #groupEditorPage .app-header {
    background: #fff;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

/* Shopping View */
.shopping-grid {
    padding: 10px 15px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding-bottom: 100px;
}
.shop-item {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    flex-direction: row;
    align-items: center;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: transform 0.1s;
}
.shop-item:active { transform: scale(0.98); }
.shop-img {
    width: 80px;
    height: 80px;
    background: #fff;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    flex-shrink: 0;
    border: 1px solid #f5f5f5;
}
.shop-img svg {
    width: 100%;
    height: 100%;
    stroke-width: 1.2;
    fill: none;
    stroke: #666;
}
.shop-info {
    padding: 0 15px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 5px;
    flex: 1;
}
.shop-name {
    font-size: 16px;
    font-weight: 600;
    color: #333;
}
.shop-price {
    font-size: 15px;
    font-weight: 700;
    color: #333;
}
.shop-action {
    padding: 8px 16px;
    background: #fee500;
    color: #3c1e1e;
    text-align: center;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
}

/* Checkbox Circle for Group Create */
.checkbox-circle {
    width: 24px; height: 24px;
    border-radius: 50%;
    border: 2px solid #ddd;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 14px;
    transition: all 0.2s;
}
.checkbox-circle.checked {
    background: var(--kakao-yellow);
    border-color: var(--kakao-yellow);
    color: #3c1e1e;
}

/* Transactions */
.transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #fff;
    border-bottom: 1px solid #f5f5f5;
}
.transaction-item:last-child { border-bottom: none; }
.transaction-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.transaction-desc {
    font-size: 16px;
    font-weight: 500;
    color: #000;
}
.transaction-date {
    font-size: 12px;
    color: #999;
}
.transaction-amount {
    font-size: 16px;
    font-weight: 600;
}
.transaction-amount.income {
    color: #d1180b; 
}
.transaction-amount.expense {
    color: #333;
}

/* Red Packet Modal */
.rp-modal {
    background: rgba(0,0,0,0.5) !important;
    display: flex; align-items: center; justify-content: center;
    z-index: 4000;
}
.rp-card {
    width: 280px; height: 420px; background: #d93f3f; border-radius: 12px;
    display: flex; flex-direction: column; align-items: center; position: relative;
    overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.rp-top {
    height: 70%; width: 100%; background: #e64c4c;
    border-bottom-left-radius: 50% 20%; border-bottom-right-radius: 50% 20%;
    display: flex; flex-direction: column; align-items: center; padding-top: 40px;
    color: #fceea8;
}
.rp-avatar {
    width: 60px; height: 60px; border-radius: 50%; border: 3px solid #fceea8;
    margin-bottom: 10px; background: #fff; object-fit: cover;
}
.rp-btn-open {
    width: 80px; height: 80px; background: #fceea8; border-radius: 50%;
    position: absolute; top: 65%; left: 50%; transform: translate(-50%, -50%);
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; font-weight: bold; color: #333; cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}
.rp-btn-open:active { transform: translate(-50%, -50%) scale(0.95); }
.rp-close {
    position: absolute; top: 10px; right: 10px; width: 24px; height: 24px;
    cursor: pointer; color: rgba(0,0,0,0.3);
}

/* Call Interface */
.call-interface {
    background: #222 !important; color: #fff;
    display: flex; flex-direction: column; align-items: center; justify-content: space-between;
    padding: 80px 0 60px;
    z-index: 5000;
}
.call-info { display: flex; flex-direction: column; align-items: center; }
.call-avatar { width: 100px; height: 100px; border-radius: 40px; margin-bottom: 20px; object-fit: cover; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
.call-name { font-size: 24px; font-weight: 600; margin-bottom: 10px; }
.call-status { font-size: 14px; opacity: 0.7; }
.call-timer { font-size: 16px; font-weight: 300; margin-top: 10px; opacity: 0; transition: opacity 0.5s; }
.call-actions {
    display: flex; gap: 40px; width: 100%; justify-content: center;
    align-items: center;
}
.call-btn {
    width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
}
.call-btn svg { width: 30px; height: 30px; stroke: #fff; stroke-width: 1.5; fill: none; }
.call-btn.end { background: #ff3b30; }
.call-btn.end:active { background: #d63026; }
.call-btn.accept { background: #34c759; }
.call-btn.mute { background: rgba(255,255,255,0.2); width: 50px; height: 50px; }
.call-btn.mute svg { width: 20px; height: 20px; }

/* Emoticon Styles */
.emoji-panel {
    height: 0; overflow: hidden; background: #e6e6e6; transition: height 0.2s;
    display: flex; flex-direction: column;
}
.emoji-panel.open { height: 250px; border-top: 1px solid #ddd; }
.emoji-tabs {
    display: flex; overflow-x: auto; background: #fff; padding: 0;
    border-bottom: 1px solid #e0e0e0; height: 40px;
    scrollbar-width: none;
}
.emoji-tabs::-webkit-scrollbar { display: none; }
.emoji-tab {
    flex: 0 0 50px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; opacity: 0.5; transition: opacity 0.2s;
}
.emoji-tab.active { opacity: 1; border-bottom: 2px solid #333; background: #f2f2f2; }
.emoji-tab img, .emoji-tab svg { width: 24px; height: 24px; object-fit: contain; }

.emoji-grid {
    flex: 1; overflow-y: auto; padding: 10px;
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
}
.emoji-item {
    aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
    cursor: pointer; border-radius: 8px;
}
.emoji-item:active { background: rgba(0,0,0,0.05); }
.emoji-item img, .emoji-item svg { width: 60px; height: 60px; object-fit: contain; }

/* Emoticon Shop */
.emo-shop-banner {
    height: 150px; background: #fee500; display: flex; flex-direction: column; 
    align-items: flex-start; justify-content: center; padding: 20px;
    margin-bottom: 10px; position: relative; overflow: hidden;
}
.emo-shop-banner h2 { font-size: 24px; font-weight: 800; color: #3c1e1e; margin-bottom: 5px; z-index: 2; }
.emo-shop-banner p { font-size: 13px; color: #3c1e1e; opacity: 0.8; z-index: 2; }
.emo-shop-banner svg { position: absolute; right: -20px; bottom: -20px; width: 140px; height: 140px; opacity: 0.2; transform: rotate(-15deg); z-index: 1; }

.emo-shop-list { padding: 10px; }
.emo-pack-item {
    display: flex; align-items: center; padding: 15px; background: #fff;
    border-radius: 12px; margin-bottom: 10px; cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}
.emo-pack-img { 
    width: 60px; height: 60px; border-radius: 12px; margin-right: 15px; 
    object-fit: cover; background: #fff; display: flex; align-items: center; justify-content: center; border: 1px solid #f5f5f5;
}
.emo-pack-info { flex: 1; }
.emo-pack-title { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
.emo-pack-desc { font-size: 12px; color: #888; }
.emo-btn-get {
    padding: 6px 14px; background: #f2f2f7; color: #333; border-radius: 16px;
    font-size: 12px; font-weight: 600; min-width: 60px; text-align: center;
}
.emo-btn-get.active { background: #fee500; color: #3c1e1e; }
.emo-btn-get.downloaded { background: #e0e0e0; color: #999; pointer-events: none; }

/* Theme UI Polish */
.theme-card {
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    transition: transform 0.1s;
    margin-bottom: 10px;
}
.theme-card:active { transform: scale(0.98); }
.theme-preview-container {
    padding: 20px; background: #fff; border-radius: 16px; margin-bottom: 20px;
    display: flex; justify-content: center; border: 1px solid #f5f5f5;
}
</style>
</head>
<body>
<div class="iphone-body">
<div class="screen">
<div class="status-bar">
<div id="clock">12:00</div>
<div class="status-right">
<span>5G</span>
<svg width="16" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"></path><path d="M1.42 9a16 16 0 0 1 21.16 0"></path><path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path><line x1="12" y1="20" x2="12.01" y2="20"></line></svg>
<div class="battery-container"><div class="battery-body"><div class="battery-fill"></div></div></div>
</div>
</div>
<div class="dynamic-island"></div>
<div class="app-header">
    <div class="header-title" id="pageTitle">好友</div>
    <div class="header-actions">
        <svg class="icon header-btn" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <svg id="addFriendBtn" onclick="openFriendEditor(false)" class="icon header-btn" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
        <svg id="createGroupChatBtn" onclick="openCreateGroupPage()" class="icon header-btn" viewBox="0 0 24 24" style="display:none;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        <svg onclick="openSettings()" class="icon header-btn" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </div>
</div>

<div class="main-view-wrapper">
    <div id="view-friends" class="view-container active">
        <div class="profile-item" onclick="openProfile('me')"><img id="myAvatar" class="avatar lg" src=""><div class="profile-info"><div class="profile-name" id="myName"></div><div class="profile-status" id="myStatus"></div></div></div>
        <div class="section-title">好友 <span id="friendCount">0</span></div><div id="friendList"></div>
    </div>

    <div id="view-chats" class="view-container">
        <div id="chatGroupBar" class="chat-group-bar"></div>
        <div id="chatList"></div>
    </div>

    <div id="view-shopping" class="view-container" style="background:#fff;">
        <div style="padding:20px 15px 0;">
            <div style="font-size:24px;font-weight:800;margin-bottom:15px;padding-left:5px;">购物中心</div>
            <!-- 搜索栏模拟 -->
            <div style="background:#eee;padding:10px 15px;border-radius:10px;color:#999;font-size:14px;display:flex;align-items:center;gap:8px;margin-bottom:15px;">
                <svg class="icon" style="width:18px;height:18px;stroke:#999;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                搜索商品...
            </div>
            <!-- 分类 Tab -->
            <div id="shopCategoryBar" style="display:flex;gap:10px;overflow-x:auto;padding-bottom:5px;scrollbar-width:none;margin-bottom:10px;">
                <!-- JS Rendered -->
            </div>
        </div>
        <div id="shoppingList" class="shopping-grid"></div>
    </div>

    <div id="view-more" class="view-container">
        <div class="more-view-header"><div class="more-title">更多</div><svg onclick="openSettings()" class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
        <div class="more-profile" onclick="openProfile('me')"><img id="moreAvatar" class="avatar" src=""><div class="profile-info"><div class="profile-name" id="moreName" style="font-size:16px;font-weight:600;"></div><div style="font-size:13px;color:#888;">user@kakao.com</div></div></div>
        <div class="pay-card" onclick="openWallet()"><div class="pay-top"><div class="pay-amount"><strong>Pay</strong> <span id="morePayBalance">¥ 0.00</span></div><div class="pay-btn">转账</div></div></div>
        <div class="section-header">服务</div>
        <div class="services-grid">
            <div class="service-item" onclick="openMasks()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div><span class="service-label">我的面具</span></div>
            <div class="service-item" onclick="openGroupManager()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><span class="service-label">分组</span></div>
            <div class="service-item" onclick="$('#viewWorldbook').classList.add('active')"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div><span class="service-label">世界书</span></div>
            <div class="service-item"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><span class="service-label">日历</span></div>
            <div class="service-item" onclick="openEmoticonShop()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></div><span class="service-label">表情包</span></div>
            <div class="service-item" onclick="openMyItemsPage()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div><span class="service-label">物品</span></div>
            <div class="service-item" onclick="openTheming()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></div><span class="service-label">美化</span></div>
            <div class="service-item" onclick="openSettings()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div><span class="service-label">设置</span></div>
        </div>
    </div>
</div>

<div class="bottom-nav">
<div class="nav-btn active" data-tab="view-friends"><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
<div class="nav-btn" data-tab="view-chats"><svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
<div class="nav-btn" data-tab="view-shopping"><svg class="icon" viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></div>
<div class="nav-btn" data-tab="view-more"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>
</div>
<div class="home-indicator" onclick="navigateWithTransition('index.html')"></div>

<div id="viewWallet" class="modal wallet-view" style="background:var(--gray-bg);">
<div class="app-header" style="background:transparent;"><svg onclick="closeModal('viewWallet')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg><div class="header-title">钱包</div><div style="width:24px;"></div></div>
<div style="flex:1;overflow-y:auto;">
<div class="wallet-card-lg">
<div style="display:flex;justify-content:space-between;"><span>Kakao Pay</span><span style="font-size:12px;background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:10px;">QR</span></div>
<div><div id="walletBalanceDisplay" style="font-size:32px;font-weight:700;">¥ 2,500.00</div><div style="font-size:12px;opacity:0.7;">可用余额</div></div>
</div>
<div class="wallet-actions">
<div class="service-item" onclick="rechargeWallet()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></div><span>充值</span></div>
<div class="service-item"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg></div><span>银行卡</span></div>
<div class="service-item" onclick="openTransactions()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div><span>账单</span></div>
</div>
</div>
</div>

<div id="pageTransactions" class="sub-page" style="background:#fff;">
    <div class="app-header" style="background:#fff;">
        <svg onclick="closeSubPage('pageTransactions')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <div class="header-title">账单</div>
        <div style="width:24px;"></div>
    </div>
    <div id="transactionList" class="sub-page-content" style="padding: 10px 0;">
        <!-- Transactions will be rendered here by JS -->
    </div>
</div>

<div id="pageEmoticonShop" class="sub-page" style="background:#fff;">
    <div class="app-header" style="background:#fff;">
        <svg onclick="closeSubPage('pageEmoticonShop')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <div class="header-title">表情商店</div>
        <div style="width:24px;"></div>
    </div>
    <div class="sub-page-content" style="background:#fff;">
        <div class="emo-shop-banner">
            <h2>KAKAO FRIENDS</h2>
            <p>挑选你最爱的表情包</p>
            <svg viewBox="0 0 24 24" fill="none" stroke="#3c1e1e" stroke-width="1"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
        </div>
        <div id="emoticonShopList" class="emo-shop-list"></div>
    </div>
</div>

<div id="modalLocation" class="modal" style="background:#fff;z-index:3500;">
    <div class="app-header" style="background:#fff;">
        <svg onclick="closeModal('modalLocation')" class="icon header-btn" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
        <div class="header-title">发送位置</div>
        <div class="header-btn" style="width:auto;font-size:16px;font-weight:600;color:#000;" onclick="sendCustomLocation()">发送</div>
    </div>
    <div style="padding:20px;">
        <div class="editor-row">
            <label class="editor-label">位置名称 / 地址</label>
            <input id="locationInput" class="editor-input" placeholder="输入地址...">
        </div>
        <div class="section-title">附近位置</div>
        <div style="background:#fff;border-radius:12px;overflow:hidden;">
            <div class="profile-item" onclick="selectLocation('江南区德黑兰路 123号')"><div class="profile-info"><div class="profile-name">江南区德黑兰路 123号</div></div></div>
            <div class="profile-item" onclick="selectLocation('首尔塔')"><div class="profile-info"><div class="profile-name">首尔塔</div></div></div>
            <div class="profile-item" onclick="selectLocation('汉江公园')"><div class="profile-info"><div class="profile-name">汉江公园</div></div></div>
        </div>
    </div>
</div>

<div id="modalTheming" class="modal" style="background:#fff;z-index:2900;">
<div class="app-header" style="background:#fff;">
<svg onclick="closeModal('modalTheming')" class="icon header-btn" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
<div class="header-title" style="font-size:17px;">主题美化</div>
<div style="width:24px;"></div>
</div>
<div style="flex:1;overflow-y:auto;padding:20px;">
<div class="preview-box" id="themePreview"><div class="preview-chat-bg" id="previewChatBg"><div class="msg-row"><div class="msg-bubble" id="previewBubbleOther">你好，这是对方的消息</div></div><div class="msg-row mine"><div class="msg-bubble" id="previewBubbleMe">这是我的消息样式预览</div></div></div></div>
<div style="text-align:center;font-size:12px;color:#999;margin-bottom:20px;">实时预览效果</div>
<div class="theme-section">
<div class="theme-label">我的气泡</div>
<div class="theme-row">
<div class="theme-card"><span>背景</span><input type="color" id="colorMeBg" value="#fee500" oninput="updateTheme('meBg', this.value)"></div>
<div class="theme-card"><span>文字</span><input type="color" id="colorMeText" value="#000000" oninput="updateTheme('meText', this.value)"></div>
</div>
</div>
<div class="theme-section">
<div class="theme-label">对方气泡</div>
<div class="theme-row">
<div class="theme-card"><span>背景</span><input type="color" id="colorOtherBg" value="#ffffff" oninput="updateTheme('otherBg', this.value)"></div>
<div class="theme-card"><span>文字</span><input type="color" id="colorOtherText" value="#000000" oninput="updateTheme('otherText', this.value)"></div>
</div>
</div>
<div class="theme-section">
<div class="theme-label">背景设置</div>
<div class="theme-row">
<div class="theme-card" onclick="$('globalBgInput').click()"><span>全局背景</span><svg class="icon" viewBox="0 0 24 24" style="width:20px;height:20px;stroke:#999;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>
<div class="theme-card" onclick="$('chatBgInput').click()"><span>聊天背景</span><svg class="icon" viewBox="0 0 24 24" style="width:20px;height:20px;stroke:#999;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
</div>
</div>
<div style="padding:20px 0;"><button onclick="resetTheme()" style="width:100%;padding:15px;background:#fff;border:none;border-radius:12px;color:#333;font-weight:600;box-shadow:0 1px 2px rgba(0,0,0,0.05);">恢复默认主题</button></div>
</div>
</div>

<div id="modalSettings" class="modal" style="background:#fff;z-index:3000;">
<div class="app-header"><svg onclick="closeModal('modalSettings')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg><div class="header-title">设置</div><div style="width:24px;"></div></div>
<div style="padding:20px;">
<div class="group-title" style="padding-left:10px;margin-bottom:10px;color:#666;font-size:13px;">AI 配置</div>
<div style="background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;text-align:center;">
    <div style="font-size:15px;color:#333;margin-bottom:10px;font-weight:600;">API 设置已移至全局</div>
    <div style="font-size:13px;color:#888;margin-bottom:20px;line-height:1.5;">
        为了统一管理所有应用的 AI 能力，请前往主屏幕的「设置」应用进行 API 配置。
    </div>
    <div style="padding:15px;background:#f9f9f9;border-radius:8px;font-size:12px;color:#666;text-align:left;">
        <div style="margin-bottom:5px;">当前状态：</div>
        <div id="globalConfigStatus">检测中...</div>
    </div>
</div>
</div>
</div>

<div id="modalProfile" class="modal profile-view">
    <div class="profile-overlay"></div>
    <div class="profile-content">
        <div class="pf-top">
            <div id="pfViewActions" style="display:flex;width:100%;justify-content:space-between;align-items:flex-start;">
                <svg onclick="closeModal('modalProfile')" class="icon" style="cursor:pointer;color:#fff;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                <div id="pfTopRightActions" style="display:flex;gap:15px;align-items:center;"></div>
            </div>
            <div id="pfEditActions" style="display:none;width:100%;justify-content:space-between;align-items:center;color:#fff;font-size:16px;padding-top:5px;">
                <div onclick="cancelProfileEdit()" style="cursor:pointer;">取消</div>
                <div style="cursor:pointer;opacity:0.7;"><svg class="icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></div>
                <div onclick="saveProfileChanges()" style="cursor:pointer;">完成</div>
            </div>
        </div>
        
        <div class="pf-main">
            <div style="position:relative;margin-bottom:10px;">
                <img id="pfAvatar" class="pf-avatar-lg" src="">
                <div id="pfAvatarEditBadge" style="display:none;position:absolute;bottom:15px;right:0;background:#fff;border-radius:50%;padding:4px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,0.2);" onclick="$('editAvatarInput').click()">
                    <svg class="icon" style="width:14px;height:14px;color:#000;" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                </div>
            </div>
            
            <div id="pfName" class="pf-name"></div>
            <div id="pfNameEdit" class="edit-row" style="display:none;">
                <input id="pfNameInput" class="edit-input" style="font-size:18px;font-weight:600;">
                <svg class="icon edit-icon" viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            </div>
            
            <div id="pfStatus" class="pf-status"></div>
            <div id="pfStatusEdit" class="edit-row" style="display:none;">
                <input id="pfStatusInput" class="edit-input" style="font-size:14px;opacity:0.8;" placeholder="输入状态信息">
                <svg class="icon edit-icon" viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            </div>
        </div>
        
        <div class="pf-footer" id="pfFooter"></div>
        <div class="pf-footer" id="pfEditFooter" style="display:none;justify-content:center;align-items:center;gap:15px;margin-bottom:60px;">
            <div onclick="$('editBgInput').click()" style="background:rgba(0,0,0,0.5);padding:8px 16px;border-radius:20px;color:#fff;font-size:13px;display:flex;align-items:center;gap:6px;cursor:pointer;">
                <svg class="icon" style="width:14px;height:14px;color:#fff;" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                编辑封面
            </div>
        </div>
    </div>
</div>

<div id="drawerSettings" class="drawer">
<div class="drawer-header"><svg onclick="closeModal('drawerSettings')" class="icon" style="cursor:pointer;"><path d="M19 12H5M12 19l-7-7 7-7"/></svg><span>详细设置</span><div style="width:24px;"></div></div>
<div class="drawer-content"><div class="group-card" style="padding:20px;display:flex;align-items:center;gap:15px;"><img id="sdAvatar" class="avatar lg" src=""><div><div id="sdName" style="font-weight:600;font-size:18px;"></div></div></div><div class="group-card"><div class="group-title" style="padding:15px 20px 5px;font-size:13px;color:#666;">形象墙</div><div class="gal-grid" id="sdGallery"></div></div><div class="group-card" onclick="editPersona()"><div class="group-item"><span>AI 人设</span><span id="sdPersona" style="font-size:13px;color:#888;max-width:150px;">默认</span></div></div><div class="group-card"><div class="group-item" style="color:var(--danger);" onclick="deleteFriend()">删除联系人</div></div></div>
</div>

<div id="drawerGift" class="drawer" style="z-index: 3500;">
    <div class="drawer-header">
        <svg onclick="closeModal('drawerGift')" class="icon" style="cursor:pointer;"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <span>送礼物</span>
        <div style="width:24px;"></div>
    </div>
    <div class="drawer-content">
        <div style="padding:10px 15px;">
            <div id="giftCategoryBar" style="display:flex;gap:10px;overflow-x:auto;padding-bottom:10px;">
                <!-- Categories -->
            </div>
            <div id="giftList" class="shopping-grid" style="grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <!-- Gifts -->
            </div>
        </div>
    </div>
</div>

<div id="drawerMyItems" class="drawer" style="z-index: 3500;">
    <div class="drawer-header">
        <svg onclick="closeModal('drawerMyItems')" class="icon" style="cursor:pointer;"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <span>我的物品</span>
        <div style="width:24px;"></div>
    </div>
    <div class="drawer-content">
        <div id="myItemsList" class="shopping-grid">
            <!-- JS will render items here -->
        </div>
    </div>
</div>

<!-- NEW: Create Group Page -->
<div id="pageCreateGroup" class="sub-page" style="background:#fff;">
    <div class="app-header" style="background:#fff;">
        <svg onclick="closeSubPage('pageCreateGroup')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <div class="header-title">创建群聊</div>
        <div id="createGroupBtn" class="header-btn" style="width:auto;font-size:16px;font-weight:600;color:#ccc;" onclick="createGroupChat()">创建(0)</div>
    </div>
    <div class="sub-page-content">
        <div class="editor-row">
            <label class="editor-label">群聊名称</label>
            <input id="createGroupName" class="editor-input" placeholder="输入群聊名称 (可选)">
        </div>
        <div class="section-title" style="margin-top:20px;">选择好友</div>
        <div id="createGroupFriendList">
            <!-- JS will render friend list with checkboxes -->
        </div>
    </div>
</div>

<!-- NEW: Group Manager Page -->
<div id="groupManagerPage" class="sub-page" style="background:#fff;">
    <div class="app-header" style="background:#fff;">
        <svg onclick="closeSubPage('groupManagerPage')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <div class="header-title">分组管理</div>
        <div class="header-btn" style="width:auto;font-size:16px;font-weight:600;color:#000;" onclick="addNewGroup()">新增</div>
    </div>
    <div id="groupListContainer" class="sub-page-content" style="padding:0;">
        <!-- JS will render groups here -->
    </div>
</div>

<!-- NEW: Group Editor Page -->
<div id="groupEditorPage" class="sub-page" style="background:#fff;">
    <div class="app-header" style="background:#fff;">
<svg onclick="closeSubPage('groupEditorPage')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        <div class="header-title">编辑分组</div>
        <div class="header-btn" style="width:auto;font-size:16px;font-weight:600;color:#000;" onclick="saveGroupEdit()">保存</div>
    </div>
    <div class="sub-page-content">
        <div class="editor-row">
            <label class="editor-label">分组名称</label>
            <input id="groupEditorName" class="editor-input" placeholder="输入分组名称">
        </div>
        <div class="section-title" style="margin-top:20px;">组成员</div>
        <div id="groupEditorMemberList">
            <!-- JS will render friend list with checkboxes -->
        </div>
        <button class="danger-btn" style="margin-top:30px;" onclick="deleteCurrentGroup()">删除分组</button>
    </div>
</div>

<div id="modalEditor" class="modal editor-modal">
<div class="app-header" style="background:#fff;">
<svg onclick="closeModal('modalEditor')" class="icon header-btn" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
<div class="header-title" id="editorTitle" style="font-size:17px;">创建角色</div>
<div class="header-btn" style="width:auto;font-size:16px;font-weight:600;color:#000;" onclick="saveEditor()">完成</div>
</div>
<div class="editor-form">
<div class="basic-row" style="display:flex;justify-content:center;margin-bottom:30px;">
<div style="text-align:center;" onclick="$('avatarInput').click()">
<img id="editAvatarPreview" style="width:100px;height:100px;border-radius:40px;background:#f5f5f5;object-fit:cover;" src="">
<div style="font-size:13px;color:#999;margin-top:10px;">点击更换头像</div>
</div>
<div id="bgUploadContainer" style="display:none;"><img id="editBgPreview" src=""></div>
</div>

<div class="editor-row basic-row"><label class="editor-label">名字 <span style="color:red">*</span></label><input id="editName" class="editor-input" placeholder="输入名字"></div>
<div class="editor-row basic-row"><label class="editor-label">状态消息</label><input id="editStatus" class="editor-input" placeholder="输入状态消息"></div>
<div class="editor-row"><label class="editor-label">我的人设 <span style="color:red">*</span></label><textarea id="editPersona" class="editor-input" placeholder="描述这个身份的性格、设定或背景故事..."></textarea></div>

<div class="editor-row" onclick="$('#viewVoiceClone').classList.add('active')" style="cursor:pointer;background:#fff;padding:15px;border-radius:12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 2px rgba(0,0,0,0.03);">
<span style="font-size:16px;">Ta 的声音</span><span style="color:#999;font-size:14px;">点击设置 ></span>
</div>

<div class="editor-row"><label class="editor-label">常用语言 <span style="color:red">*</span></label><input id="editLang" class="editor-input" placeholder="例如：中文、英语"></div>
<div class="editor-row"><label class="editor-label">与我的关系</label><input id="editRelation" class="editor-input" placeholder="例如：朋友、同事"></div>
<div class="editor-row"><label class="editor-label">我的面具 </label><select id="editMaskId" class="editor-input"><option value="">默认身份</option></select></div>
<div class="editor-row"><label class="editor-label">世界观 </label><select id="editWorld" class="editor-input"><option value="">无</option></select></div>
<div class="editor-row"><label class="editor-label">聊天开场白</label><input id="editGreeting" class="editor-input" placeholder="第一句说什么..."></div>
</div>
</div>

<div id="modalContactEdit" class="modal editor-modal">
    <div class="app-header" style="background:#fff;">
        <svg onclick="closeModal('modalContactEdit')" class="icon header-btn" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
        <div class="header-title" style="font-size:17px;">编辑联系人</div>
        <div class="header-btn" style="width:auto;font-size:16px;font-weight:600;color:#000;" onclick="saveContactEdit()">完成</div>
    </div>
    <div class="editor-form">
        <div style="display:flex;justify-content:center;margin-bottom:30px;">
            <div style="text-align:center;" onclick="$('contactEditAvatarInput').click()">
                <img id="contactEditAvatarPreview" style="width:100px;height:100px;border-radius:40px;background:#f5f5f5;object-fit:cover;" src="">
                <div style="font-size:13px;color:#999;margin-top:10px;">点击更换头像</div>
            </div>
        </div>
        <div class="editor-row"><label class="editor-label">名字</label><input id="contactEditName" class="editor-input" placeholder="输入名字"></div>
        <div class="editor-row"><label class="editor-label">个性签名</label><input id="contactEditStatus" class="editor-input" placeholder="输入状态消息"></div>
        <div class="editor-row"><label class="editor-label">世界观</label><select id="contactEditWorld" class="editor-input"><option value="">无</option></select></div>
        <input type="file" id="contactEditAvatarInput" hidden accept="image/*" onchange="handleContactFile(this)">
    </div>
</div>

    <div id="viewWorldbook" class="modal" style="background:#fff;z-index:3100;">
        <div class="app-header" style="background:#fff;">
            <svg onclick="closeModal('viewWorldbook')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            <div class="header-title">世界书</div><div style="width:24px;"></div>
        </div>
        <div style="padding:20px;">
            <div style="text-align:center;color:#999;margin-top:50px;">暂无世界设定</div>
            <button style="position:absolute;bottom:30px;left:20px;right:20px;padding:15px;background:#fee500;border:none;border-radius:12px;font-weight:600;" onclick="alert('创建新世界书...')">创建新世界</button>
        </div>
    </div>

<div id="viewVoiceClone" class="modal" style="background:#fff;z-index:3100;">
<div class="app-header" style="background:#fff;">
<svg onclick="closeModal('viewVoiceClone')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
<div class="header-title">声音克隆</div><div style="width:24px;"></div>
</div>
<div style="padding:20px;">
<div class="group-card" style="padding:20px;">
<div style="margin-bottom:15px;font-size:14px;color:#666;">请上传 3 段语音文件 (时长可以超过一分钟，单文件最大 10MB)</div>
<input type="file" class="editor-input" style="margin-bottom:10px;background:#f9f9f9;" accept="audio/*" onchange="handleVoiceUpload(this)">
<input type="file" class="editor-input" style="margin-bottom:10px;background:#f9f9f9;" accept="audio/*" onchange="handleVoiceUpload(this)">
<input type="file" class="editor-input" style="margin-bottom:20px;background:#f9f9f9;" accept="audio/*" onchange="handleVoiceUpload(this)">
<div style="border-top:1px solid #eee;margin-bottom:20px;"></div>
<label class="editor-label">试听文本</label>
<input id="voicePreviewText" class="editor-input" placeholder="输入要试听的话..." style="margin-bottom:15px;background:#f9f9f9;">
<button id="btnPreviewVoice" style="width:100%;padding:12px;background:#fee500;border:none;border-radius:8px;font-weight:600;font-size:15px;" onclick="previewVoiceClone()">🎵 试听克隆声音</button>
<div id="voicePreviewStatus" style="margin-top:10px;text-align:center;font-size:13px;color:#888;display:none;"></div>
</div>
<div style="margin-top:20px;text-align:center;">
<button onclick="closeModal('viewVoiceClone')" style="width:100%;padding:15px;background:#3c1e1e;color:#fff;border:none;border-radius:12px;font-weight:600;">保存设置</button>
</div>
</div>
</div>

<div id="modalMasks" class="modal" style="background:#fff;z-index:2800;">
<div class="app-header" style="background:#fff;">
<svg onclick="closeModal('modalMasks')" class="icon header-btn" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
<div class="header-title" style="font-size:17px;">我的面具</div>
<div style="width:24px;"></div>
</div>
<div style="padding:20px 0;"><div class="section-title">选择身份</div><div id="maskList" class="mask-list"></div></div>
</div>

<div id="chatRoom" class="chat-room">
<div class="app-header" style="height:60px;padding-top:10px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);">
<svg onclick="closeChat()" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
<div id="chatTitle" style="font-weight:600;font-size:17px;"></div>
<svg onclick="toggleChatDrawer()" class="icon header-btn" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</div>
<div id="chatMsgs" class="chat-msgs"></div>
<div class="chat-footer">
<svg onclick="toggleChatExtra()" class="icon header-btn" style="color:#888;" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
<svg onclick="toggleEmojiPanel()" class="icon header-btn" style="color:#888;margin-right:8px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
<input id="chatInput" class="chat-input" placeholder="发送消息...">
<div onclick="sendMsg()" style="width:34px;height:34px;background:#fee500;border-radius:17px;display:flex;align-items:center;justify-content:center;font-size:14px;">➤</div>
</div>
<div id="emojiPanel" class="emoji-panel">
    <div id="emojiTabs" class="emoji-tabs"></div>
    <div id="emojiGrid" class="emoji-grid"></div>
</div>
<div id="chatExtra" class="chat-extra">
<div class="service-item" onclick="$('chatImgInput').click()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div><span>相册</span></div>
<div class="service-item" onclick="openCamera()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div><span>拍摄</span></div>
<div class="service-item" onclick="openTransfer()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div><span>转账</span></div>
<div class="service-item" onclick="openRedPacket()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></div><span>红包</span></div>
<div class="service-item" onclick="startVoiceCall()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.05 12.05 0 0 0 .57 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.05 12.05 0 0 0 2.81.57A2 2 0 0 1 22 16.92z"></svg></div><span>语音通话</span></div>
<div class="service-item" onclick="startVideoCall()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg></div><span>视频通话</span></div>
<div class="service-item" onclick="openLocation()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div><span>位置</span></div>
<div class="service-item" onclick="openGiftSelect()"><div class="svc-icon-box"><svg class="svc-icon" viewBox="0 0 24 24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg></div><span>礼物</span></div>
</div>
</div>

<!-- Chat Settings Page (New Customized Layout) -->
<div id="chatSettingsPage" class="chat-settings-page" style="background: #fff;">
    <!-- Header -->
    <div class="app-header" style="background:transparent; border:none; justify-content: flex-end; padding-top:10px;">
        <svg onclick="toggleChatDrawer()" class="icon header-btn" viewBox="0 0 24 24" style="color: #333;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </div>
    
    <div class="cs-content">
        
        <!-- 1. Top Contact Info -->
        <div class="cs-top-profile">
             <img id="csAvatar" class="cs-avatar-lg" src="">
             <div id="csName" class="cs-name-lg" onclick="editChatName()"></div>
             <div id="csStatus" class="cs-desc"></div>
        </div>

        <!-- 2. Settings List (Function Group) -->
        <div class="cs-card" id="csSettingsList">
            <!-- JS populated -->
        </div>


        <!-- 4. Participants -->
        <div class="cs-card">
            <div class="cs-part-header">
                <span>参与者</span>
                <span id="csPartCount" style="color:#8e8e93;font-weight:400;font-size:14px;"></span>
            </div>
            <div id="csParticipantsList" class="cs-part-list">
                <!-- JS Populated -->
            </div>
        </div>
        

    </div>

    <!-- Sub-page: Schedule (Nested in Chat Settings to match size) -->
    <div id="pageSchedule" class="sub-page" style="background:#fff;">
        <div class="app-header" style="background:#fff;">
            <svg onclick="closeSubPage('pageSchedule')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            <div class="header-title">行程表</div>
            <div style="width:24px;"></div>
        </div>
    <div class="sub-page-content" style="background:#fff;">
        <div id="fullScheduleList" class="timeline-list"></div>
    </div>
</div>

    <!-- Sub-page: Anniversary -->
    <div id="pageAnniversary" class="sub-page" style="background:#fff;">
        <div class="app-header" style="background:#fff;">
            <svg onclick="closeSubPage('pageAnniversary')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            <div class="header-title">纪念日</div>
            <div style="width:24px;"></div>
        </div>
        <div class="sub-page-content" style="background:#fff;">
            <div class="calendar-full">
                <div class="cal-header">
                    <span style="cursor:pointer;padding:10px;" onclick="changeFullMonth(-1)">‹</span>
                    <span id="fullCalTitle" class="cal-title" style="font-size:18px;"></span>
                    <span style="cursor:pointer;padding:10px;" onclick="changeFullMonth(1)">›</span>
                </div>
                <div class="cal-grid" style="margin-bottom:10px;font-weight:bold;color:#333;">
                    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                </div>
                <div class="cal-grid" id="fullCalGrid" style="height:300px;align-content:start;"></div>
            </div>
            <div class="anniversary-list">
                <div class="section-title">本月纪念日</div>
                <div id="monthAnniversaries"></div>
            </div>
        </div>
    </div>

    <!-- Sub-page: Chat Gallery (形象) -->
    <div id="pageChatGallery" class="sub-page" style="background:#fff;">
        <div class="app-header" style="background:#fff;">
            <svg onclick="closeSubPage('pageChatGallery')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            <div class="header-title">形象墙</div>
            <div class="header-btn" style="width:auto;font-size:16px;color:#007aff;" onclick="$('galleryInput').click()">上传</div>
        </div>
        <div class="sub-page-content" style="background:#fff;">
             <div id="chatGalleryGrid" class="cs-gallery-grid"></div>
        </div>
    </div>

    <!-- Sub-page: Search History -->
    <div id="pageSearchHistory" class="sub-page" style="background:#fff;">
        <div class="app-header" style="background:#fff;">
            <svg onclick="closeSubPage('pageSearchHistory')" class="icon header-btn" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            <div class="header-title">查找聊天记录</div>
            <div style="width:24px;"></div>
        </div>
        <div class="sub-page-content" style="background:#fff; display:flex; flex-direction:column;">
             <div style="padding: 15px; background: #f2f2f7; border-bottom: 1px solid #e5e5ea;">
                 <div style="background:#e3e3e8; border-radius:10px; padding:8px 12px; display:flex; align-items:center;">
                     <svg class="icon" style="width:16px;height:16px;color:#8e8e93;margin-right:8px;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                     <input id="chatHistorySearchInput" placeholder="搜索对话内容" style="border:none; background:transparent; width:100%; font-size:15px; outline:none;" oninput="performChatSearch(this.value)">
                 </div>
             </div>
             <div id="chatSearchResults" style="flex:1; overflow-y:auto; padding:0;">
                 <!-- Results -->
             </div>
        </div>
    </div>

</div>
</div>
</div>

<!-- Red Packet Modal -->
<div id="modalRedPacket" class="rp-modal" style="display:none;">
    <div class="rp-card">
        <div class="rp-close" onclick="closeRedPacket()">✕</div>
        <div class="rp-top">
            <img id="rpAvatar" class="rp-avatar" src="">
            <div id="rpName" style="font-size:16px;font-weight:600;margin-bottom:5px;"></div>
            <div style="font-size:14px;opacity:0.8;">发了一个红包</div>
            <div id="rpMsg" style="font-size:18px;margin-top:15px;max-width:80%;text-align:center;">恭喜发财，大吉大利</div>
        </div>
        <div class="rp-btn-open" onclick="openRedPacketAction()">開</div>
        <div style="margin-top:80px;font-size:12px;color:#999;cursor:pointer;">查看领取详情 ></div>
    </div>
</div>

<!-- Call Interface Modal -->
<div id="modalCall" class="modal call-interface" style="display:none;">
    <div class="call-info">
        <img id="callAvatar" class="call-avatar" src="">
        <div id="callName" class="call-name"></div>
        <div id="callStatus" class="call-status">正在呼叫...</div>
        <div id="callTimer" class="call-timer">00:00</div>
    </div>
    
    <div class="call-actions">
        <div class="call-btn mute" onclick="toggleMute()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
        </div>
        <div class="call-btn end" onclick="endCall()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.05 12.05 0 0 0 2.81.57 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.05 12.05 0 0 0 .57 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"/></svg>
        </div>
        <div class="call-btn mute" onclick="toggleSpeaker()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
        </div>
    </div>
</div>

<!-- Hidden Inputs -->
<input type="file" id="avatarInput" hidden accept="image/*">
<input type="file" id="bgInput" hidden accept="image/*">
<input type="file" id="profileBgInput" hidden accept="image/*">
<input type="file" id="chatImgInput" hidden accept="image/*" onchange="handleChatImage(this)">
<input type="file" id="galleryInput" hidden accept="image/*" multiple onchange="handleGalleryUpload(this)">
<input type="file" id="globalBgInput" hidden accept="image/*" onchange="handleThemeFile(this, 'globalBg')">
<input type="file" id="chatBgInput" hidden accept="image/*" onchange="handleThemeFile(this, 'chatBg')">
<input type="file" id="editAvatarInput" hidden accept="image/*" onchange="handleProfileEditFile(this, 'avatar')">
<input type="file" id="editBgInput" hidden accept="image/*" onchange="handleProfileEditFile(this, 'bg')">
<input type="file" id="editGroupAvatarInput" hidden accept="image/*" onchange="handleGroupAvatar(this)">

<script>
const $ = id => document.getElementById(id);

function navigateWithTransition(url) {
    window.location.href = url;
}

function loadWorldOptions(selectId, selectedValue) {
    const select = $(selectId);
    if (!select) return;
    select.innerHTML = '<option value="">无</option>';
    
    try {
        const worldData = JSON.parse(localStorage.getItem('worldbook_data') || '[]');
        worldData.forEach(w => {
            const option = document.createElement('option');
            option.value = w.id;
            option.textContent = w.title;
            if (w.id === selectedValue) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    } catch (e) {
        console.error("Error loading world data", e);
    }
    
    if (selectedValue) {
        select.value = selectedValue;
    }
}

// SVG 图标库 - 精致白底灰线风格
const svgs = {
    // Food
    boba: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8h1a4 4 0 0 1 0 8h-1"/><path d="M6 8v11a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8"/><line x1="6" y1="8" x2="18" y2="8"/><line x1="9" y1="8" x2="9" y2="2"/><circle cx="12" cy="15" r="0.5" fill="#888" stroke="none"/><circle cx="10" cy="17" r="0.5" fill="#888" stroke="none"/><circle cx="14" cy="17" r="0.5" fill="#888" stroke="none"/></svg>',
    cake: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M7 8v3"/><path d="M12 8v3"/><path d="M17 8v3"/><path d="M7 4h.01"/><path d="M12 4h.01"/><path d="M17 4h.01"/></svg>',
    chicken: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 14s2-2 3-5a5 5 0 1 1 9 4c-3 3-5 5-5 5L6 14z"/><path d="M6 14l-2 3a2 2 0 0 0 2 2h2"/></svg>',
    choco: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="4" y1="12" x2="20" y2="12"/><path d="M4 8h16"/><path d="M8 4v16"/><path d="M16 4v16"/><path d="M4 16h16"/></svg>',
    latte: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
    pizza: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 22h20L12 2z"/><circle cx="12" cy="14" r="1.5"/><circle cx="9" cy="18" r="1"/><circle cx="15" cy="18" r="1"/></svg>',
    sushi: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="12" width="16" height="8" rx="4"/><path d="M4 12c0-2.2 3.6-4 8-4s8 1.8 8 4"/><path d="M8 8c0-1.5 2-3 4-3s4 1.5 4 3"/></svg>',
    icecream: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22l-8-10a5 5 0 0 1 8.8-3.5 5 5 0 0 1 7.2 3.5L12 22z"/><path d="M12 22L4 12"/><path d="M12 22l8-10"/></svg>',
    donut: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"/><circle cx="12" cy="12" r="3"/></svg>',
    fruit: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="8"/><path d="M12 4a8 8 0 0 1 8 8"/><path d="M12 12l5-5"/></svg>',
    
    // Beauty
    lipstick: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l-2 4h4l-2-4z"/><rect x="8" y="6" width="8" height="16" rx="1"/></svg>',
    perfume: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="10" width="12" height="12" rx="2"/><path d="M12 10V6"/><path d="M9 6h6"/><circle cx="12" cy="4" r="2"/></svg>',
    lotion: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 22V10a5 5 0 0 1 10 0v12"/><path d="M7 22h10"/><path d="M12 10V6"/><path d="M12 6H9"/></svg>',
    mask: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-6-2-6-10 2-8 6-8 6 2 6 8-6 10-6 10z"/><circle cx="9" cy="10" r="1" fill="#888" stroke="none"/><circle cx="15" cy="10" r="1" fill="#888" stroke="none"/><path d="M10 16a3 3 0 0 0 4 0"/></svg>',
    eyeshadow: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="7" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="17" cy="12" r="2"/></svg>',
    foundation: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="8" width="12" height="14" rx="2"/><path d="M12 8V4"/><path d="M9 4h6"/></svg>',
    nail: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 10H10V6a2 2 0 0 1 4 0v4z"/><rect x="8" y="10" width="8" height="12" rx="2"/></svg>',
    brushes: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 22l-2-8a2 2 0 0 1 4 0l-2 8z"/><path d="M15 22l-2-8a2 2 0 0 1 4 0l-2 8z"/></svg>',
    
    // Fashion
    necklace: '<svg viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4c0 8 4 14 6 14s6-6 6-14"/><circle cx="12" cy="18" r="2"/></svg>',
    hairclip: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="10" width="16" height="4" rx="2"/><circle cx="6" cy="12" r="1"/><circle cx="18" cy="12" r="1"/></svg>',
    pajamas: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4l6-2 6 2v10l-6 2-6-2V4z"/><path d="M12 2v20"/></svg>',
    bag: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 10h12v10a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V10z"/><path d="M9 10V6a3 3 0 0 1 6 0v4"/></svg>',
    cap: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 14c-4 0-7-4-10-4S5 14 5 14v2h17v-2z"/><path d="M12 10a4 4 0 0 1 4-4h-8a4 4 0 0 1 4 4"/></svg>',
    socks: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v10l-4 4v4h6l4-4V2H10z"/></svg>',
    scarf: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2h8v16l-4 4-4-4V2z"/><line x1="8" y1="18" x2="16" y2="18"/></svg>',
    earrings: '<svg viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="3"/><circle cx="16" cy="8" r="3"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="16" y1="11" x2="16" y2="16"/></svg>',
    slippers: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14h16v4a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-4z"/><path d="M4 14c0-4 4-8 8-8s8 4 8 8"/></svg>',

    // Lifestyle
    toy: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M6 21v-7a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v7"/><path d="M9 21v-4"/><path d="M15 21v-4"/></svg>',
    candle: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="10" width="8" height="12" rx="1"/><path d="M12 10V6"/><ellipse cx="12" cy="4" rx="1" ry="2"/></svg>',
    flower: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="2"/><path d="M12 2l2 4 4 2-4 2-2 4-2-4-4-2 4-2 2-4z"/><path d="M12 14v8"/></svg>',
    camera: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="8" width="16" height="12" rx="2"/><circle cx="12" cy="14" r="3"/><rect x="8" y="4" width="8" height="4" rx="1"/></svg>',
    pillow: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="6" width="16" height="12" rx="4"/><path d="M4 6l4 4"/><path d="M20 6l-4 4"/><path d="M4 18l4-4"/><path d="M20 18l-4-4"/></svg>',
    humidifier: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="8" width="8" height="14" rx="2"/><path d="M10 5q2-3 4 0"/><path d="M12 2q2-3 2 0"/></svg>',
    speaker: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="12" height="16" rx="2"/><circle cx="12" cy="15" r="3"/><circle cx="12" cy="8" r="1"/></svg>',
    lamp: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 12h8l2 10H6l2-10z"/><path d="M12 12V6"/><circle cx="12" cy="4" r="2"/></svg>',
    plant: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22l-2-6h4l-2 6z"/><path d="M12 16v-6"/><path d="M12 10c-4 0-4-4-4-4s4 0 4 4"/><path d="M12 12c4 0 4-4 4-4s-4 0-4 4"/></svg>',
    notebook: '<svg viewBox="0 0 24 24" fill="#fff" stroke="#888" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="12" height="16" rx="1"/><line x1="8" y1="4" x2="8" y2="20"/></svg>'
};

const products = [
    // Food (美食)
    { id: 101, name: '奶茶', price: 28, category: 'food', image: svgs.boba },
    { id: 102, name: '奶油蛋糕', price: 48, category: 'food', image: svgs.cake },
    { id: 103, name: '韩式炸鸡套餐', price: 88, category: 'food', image: svgs.chicken },
    { id: 104, name: '歌帝梵巧克力', price: 158, category: 'food', image: svgs.choco },
    { id: 105, name: '马卡龙礼盒', price: 98, category: 'food', image: svgs.donut }, // Reusing donut shape
    { id: 106, name: '星巴克拿铁', price: 32, category: 'food', image: svgs.latte },
    { id: 107, name: '提拉米苏', price: 45, category: 'food', image: svgs.cake },
    { id: 108, name: '必胜客披萨', price: 79, category: 'food', image: svgs.pizza },
    { id: 109, name: '日式寿司拼盘', price: 128, category: 'food', image: svgs.sushi },
    { id: 110, name: '哈根达斯冰淇淋', price: 38, category: 'food', image: svgs.icecream },
    { id: 111, name: '甜甜圈礼盒', price: 58, category: 'food', image: svgs.donut },
    { id: 112, name: '鲜果切盘', price: 35, category: 'food', image: svgs.fruit },

    // Beauty (美妆)
    { id: 201, name: 'YSL 小金条', price: 335, category: 'beauty', image: svgs.lipstick },
    { id: 202, name: '香奈儿 5号香水', price: 790, category: 'beauty', image: svgs.perfume },
    { id: 203, name: '欧舒丹护手霜', price: 90, category: 'beauty', image: svgs.lotion },
    { id: 204, name: 'SK-II 面膜', price: 120, category: 'beauty', image: svgs.mask },
    { id: 205, name: '3CE 眼影盘', price: 189, category: 'beauty', image: svgs.eyeshadow },
    { id: 206, name: 'Dior 气垫BB', price: 580, category: 'beauty', image: svgs.foundation },
    { id: 207, name: 'MAC 子弹头', price: 175, category: 'beauty', image: svgs.lipstick },
    { id: 208, name: '祖玛珑香薰', price: 450, category: 'beauty', image: svgs.perfume },
    { id: 209, name: '指甲油套装', price: 69, category: 'beauty', image: svgs.nail },
    { id: 210, name: '腮红', price: 145, category: 'beauty', image: svgs.eyeshadow },
    { id: 211, name: '化妆刷套装', price: 128, category: 'beauty', image: svgs.brushes },
    { id: 212, name: '润唇膏', price: 55, category: 'beauty', image: svgs.lipstick },

    // Fashion (穿搭)
    { id: 301, name: '纯银锁骨链', price: 228, category: 'fashion', image: svgs.necklace }, // placeholder
    { id: 302, name: '可爱发卡套装', price: 39, category: 'fashion', image: svgs.hairclip }, // placeholder
    { id: 303, name: 'INS风睡衣', price: 159, category: 'fashion', image: svgs.pajamas }, // placeholder
    { id: 304, name: '帆布包', price: 69, category: 'fashion', image: svgs.bag }, // placeholder
    { id: 305, name: '棒球帽', price: 89, category: 'fashion', image: svgs.cap }, // placeholder
    { id: 306, name: '纯棉堆堆袜', price: 29, category: 'fashion', image: svgs.socks }, // placeholder
    { id: 307, name: '丝绸围巾', price: 199, category: 'fashion', image: svgs.scarf }, // placeholder
    { id: 308, name: '珍珠耳钉', price: 260, category: 'fashion', image: svgs.earrings }, // placeholder
    { id: 309, name: '卡包', price: 120, category: 'fashion', image: svgs.bag },
    { id: 310, name: '居家拖鞋', price: 49, category: 'fashion', image: svgs.slippers }, // placeholder

    // Lifestyle (生活)
    { id: 401, name: '泡泡玛特盲盒', price: 69, category: 'lifestyle', image: svgs.toy }, // placeholder
    { id: 402, name: '香薰蜡烛', price: 128, category: 'lifestyle', image: svgs.candle }, // placeholder
    { id: 403, name: '鲜花束 (同城)', price: 199, category: 'lifestyle', image: svgs.flower }, // placeholder
    { id: 404, name: '拍立得相机', price: 599, category: 'lifestyle', image: svgs.camera }, // placeholder
    { id: 405, name: '可爱抱枕', price: 88, category: 'lifestyle', image: svgs.pillow }, // placeholder
    { id: 406, name: '加湿器', price: 128, category: 'lifestyle', image: svgs.humidifier }, // placeholder
    { id: 407, name: '蓝牙音箱', price: 299, category: 'lifestyle', image: svgs.speaker }, // placeholder
    { id: 408, name: '日落灯', price: 59, category: 'lifestyle', image: svgs.lamp }, // placeholder
    { id: 409, name: '多肉盆栽', price: 35, category: 'lifestyle', image: svgs.plant }, // placeholder
    { id: 410, name: '精致手账本', price: 65, category: 'lifestyle', image: svgs.notebook } // placeholder
];

let activeShopCategory = 'all';
window.switchShopCategory = (cat) => {
    activeShopCategory = cat;
    render();
};

let activeGiftCategory = 'all';
window.switchGiftCategory = (cat) => {
    activeGiftCategory = cat;
    renderGiftList(); // Separate render for gift drawer
};

// EMOTICON DATA
const emoticonPacks = [
    {
        id: 'ryan',
        name: 'Ryan 的日常',
        desc: '可爱的狮子 Ryan',
        thumb: 'https://api.iconify.design/noto:lion.svg',
        items: [
            'https://api.iconify.design/noto:lion.svg',
            'https://api.iconify.design/noto:face-with-tears-of-joy.svg',
            'https://api.iconify.design/noto:thumbs-up.svg',
            'https://api.iconify.design/noto:waving-hand.svg',
            'https://api.iconify.design/noto:heart-suit.svg',
            'https://api.iconify.design/noto:party-popper.svg',
            'https://api.iconify.design/noto:sleeping-face.svg',
            'https://api.iconify.design/noto:thinking-face.svg'
        ]
    },
    {
        id: 'apeach',
        name: 'Apeach 桃子',
        desc: '调皮的桃子',
        thumb: 'https://api.iconify.design/noto:peach.svg',
        items: [
            'https://api.iconify.design/noto:peach.svg',
            'https://api.iconify.design/noto:smiling-face-with-heart-eyes.svg',
            'https://api.iconify.design/noto:loudly-crying-face.svg',
            'https://api.iconify.design/noto:kiss-mark.svg',
            'https://api.iconify.design/noto:folded-hands.svg',
            'https://api.iconify.design/noto:sparkles.svg',
            'https://api.iconify.design/noto:z-z-z.svg',
            'https://api.iconify.design/noto:anger-symbol.svg'
        ]
    },
    {
        id: 'muzi',
        name: 'Muzi & Con',
        desc: '兔子和鳄鱼',
        thumb: 'https://api.iconify.design/noto:rabbit-face.svg',
        items: [
            'https://api.iconify.design/noto:rabbit-face.svg',
            'https://api.iconify.design/noto:crocodile.svg',
            'https://api.iconify.design/noto:carrot.svg',
            'https://api.iconify.design/noto:running-shoe.svg',
            'https://api.iconify.design/noto:grinning-face-with-sweat.svg',
            'https://api.iconify.design/noto:fearful-face.svg',
            'https://api.iconify.design/noto:clapping-hands.svg',
            'https://api.iconify.design/noto:ok-hand.svg'
        ]
    }
];

// Data
const DEFAULTS = {
    user: { 
        id:'me', name:'User', status:'', avatar:'https://ui-avatars.com/api/?name=User&background=fee500&color=3c1e1e', bgImage:'',
        masks: [],
        items: [] 
    },
    friends: [], 
    groups: ['Friends', 'Family', 'Lovers'], // Default groups
    worldbooks: [],
    wallet: { balance: 2500, transactions: [] },
    emoticons: ['ryan']
};

let state = {
    user: JSON.parse(localStorage.getItem('kt_user_v4')) || DEFAULTS.user,
    friends: JSON.parse(localStorage.getItem('kt_friends_v4')) || DEFAULTS.friends,
    groups: JSON.parse(localStorage.getItem('kt_groups_v4')) || DEFAULTS.groups,
    chats: JSON.parse(localStorage.getItem('kt_chats_v4')) || [],
    worldbooks: JSON.parse(localStorage.getItem('kt_worldbooks_v4')) || DEFAULTS.worldbooks,
    wallet: JSON.parse(localStorage.getItem('kt_wallet_v4')) || DEFAULTS.wallet,
    emoticons: JSON.parse(localStorage.getItem('kt_emoticons_v4')) || DEFAULTS.emoticons,
    activeChatGroup: 'All'
};

let editingId = null; // Global variable for editor state
let aiReplyTimers = {}; // Key: chatId, Value: timerId
let userTypingTimer = null;

// THEMING CONFIG
let themeConfig = JSON.parse(localStorage.getItem('kt_theme_config')) || {
    globalBg: '', chatBg: '', 
    meBg: '#fee500', meText: '#000000', meImg: '',
    otherBg: '#ffffff', otherText: '#000000', otherImg: ''
};

const save = () => {
    localStorage.setItem('kt_user_v4', JSON.stringify(state.user));
    localStorage.setItem('kt_friends_v4', JSON.stringify(state.friends));
    localStorage.setItem('kt_groups_v4', JSON.stringify(state.groups));
    localStorage.setItem('kt_chats_v4', JSON.stringify(state.chats));
    localStorage.setItem('kt_worldbooks_v4', JSON.stringify(state.worldbooks));
    localStorage.setItem('kt_wallet_v4', JSON.stringify(state.wallet));
    localStorage.setItem('kt_emoticons_v4', JSON.stringify(state.emoticons));
    render();
};

function navigateWithTransition(url) {
    window.location.href = url;
}

function init() {
    applyTheme(); 
    render();
    
    // Tabs
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.onclick = () => {
            const tabId = btn.dataset.tab;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            const target = $(tabId);
            if(target) target.classList.add('active');
            
            if(tabId === 'view-more') {
                document.querySelector('.app-header').style.display = 'none';
            } else {
                document.querySelector('.app-header').style.display = 'flex';
                const titles = { 'view-friends':'好友', 'view-chats':'聊天', 'view-shopping':'购物' };
                if($('pageTitle')) $('pageTitle').innerText = titles[tabId];

                // Toggle Header Buttons based on Tab
                if(tabId === 'view-friends') {
                    if($('addFriendBtn')) $('addFriendBtn').style.display = 'block';
                    if($('createGroupChatBtn')) $('createGroupChatBtn').style.display = 'none';
                } else if(tabId === 'view-chats') {
                    if($('addFriendBtn')) $('addFriendBtn').style.display = 'none';
                    if($('createGroupChatBtn')) $('createGroupChatBtn').style.display = 'block';
                } else {
                    // Default behavior for other tabs if header is shown
                    if($('addFriendBtn')) $('addFriendBtn').style.display = 'none';
                    if($('createGroupChatBtn')) $('createGroupChatBtn').style.display = 'none';
                }
            }
            if(tabId === 'view-shopping') {
                 // Hide global header for shopping as it has its own internal structure
                 document.querySelector('.app-header').style.display = 'none';
            }
        }
    });

    // Inputs
    const avInput = $('avatarInput'); if(avInput) avInput.onchange = e => handleFile(e, 'avatar');
    const bgInput = $('bgInput'); if(bgInput) bgInput.onchange = e => handleFile(e, 'bg');
    const pfBgInput = $('profileBgInput'); if(pfBgInput) pfBgInput.onchange = e => handleProfileBg(e);
    
    // Chat Input Listener for AI Logic
    const chatInput = $('chatInput');
    if (chatInput) {
        chatInput.addEventListener('input', () => {
            // 用户正在输入，暂停 AI 回复
            if (activeChatId && aiReplyTimers[activeChatId]) {
                clearTimeout(aiReplyTimers[activeChatId]);
                delete aiReplyTimers[activeChatId];
            }
            
            // 防抖：用户停止输入 1.5 秒后，重新检查是否需要 AI 回复
            clearTimeout(userTypingTimer);
            userTypingTimer = setTimeout(() => {
                checkAndScheduleAI(activeChatId);
            }, 1500);
        });
    }

    // Check Global Config Status
    updateGlobalConfigStatus();
    // Re-check when settings modal opens
    const settingsBtn = document.querySelector('svg[onclick="openSettings()"]');
    if(settingsBtn) {
        const originalOnClick = settingsBtn.onclick;
        settingsBtn.onclick = function(e) {
            updateGlobalConfigStatus();
            if(originalOnClick) originalOnClick.call(this, e);
        };
    }

    setInterval(() => {
        const d = new Date();
        const clk = $('clock');
        if(clk) clk.innerText = d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');
    }, 1000);

}

function render() {
    // Wallet in More View
    if($('morePayBalance')) $('morePayBalance').innerText = `¥ ${state.wallet.balance.toFixed(2)}`;

    // Me
    if($('myAvatar')) $('myAvatar').src = state.user.avatar;
    if($('myName')) $('myName').innerText = state.user.name;
    if($('myStatus')) $('myStatus').innerText = state.user.status || '';
    if($('moreAvatar')) $('moreAvatar').src = state.user.avatar;
    if($('moreName')) $('moreName').innerText = state.user.name;
    
    // Friends List
    if($('friendCount')) $('friendCount').innerText = state.friends.length;
    if($('friendList')) {
        if(state.friends.length === 0) {
            $('friendList').innerHTML = `<div style="text-align:center;margin-top:100px;color:#999;font-size:14px;">暂无联系人</div>`;
        } else {
            const sortedFriends = [...state.friends].sort((a,b) => a.name.localeCompare(b.name, 'zh-CN'));
            let html = sortedFriends.map(f => `
                <div class="profile-item" onclick='openProfile(${JSON.stringify(f).replace(/'/g, "&#39;")})'>
                    <img class="avatar" src="${f.avatar}">
                    <div class="profile-info">
                        <div class="profile-name">${f.name}</div>
                        <div class="profile-status">${f.status||''}</div>
                    </div>
                </div>
            `).join('');
            $('friendList').innerHTML = html;
        }
    }

    // Chat Groups Bar
    if($('chatGroupBar')) {
        const allGroups = ['All', ...state.groups];
        $('chatGroupBar').innerHTML = allGroups.map(g => `
            <div class="chat-group-pill ${state.activeChatGroup === g ? 'active' : ''}" 
                 onclick="setChatGroup('${g}')">
                 ${g}
            </div>
        `).join('');
    }

    // Shopping List
    if($('shoppingList')) {
        // Render Categories
        const cats = [
            {id:'all', name:'全部'},
            {id:'food', name:'美食'},
            {id:'beauty', name:'美妆'},
            {id:'fashion', name:'穿搭'},
            {id:'lifestyle', name:'生活'}
        ];
        
        if($('shopCategoryBar')) {
            $('shopCategoryBar').innerHTML = cats.map(c => `
                <div onclick="switchShopCategory('${c.id}')" 
                     style="padding:8px 16px;border-radius:18px;font-size:13px;white-space:nowrap;cursor:pointer;transition:all 0.2s;
                     ${activeShopCategory===c.id ? 'background:#333;color:#fff;font-weight:600;' : 'background:#fff;color:#666;border:1px solid #eee;'}">
                    ${c.name}
                </div>
            `).join('');
        }

        const filteredProducts = activeShopCategory === 'all' 
            ? products 
            : products.filter(p => p.category === activeShopCategory);

        $('shoppingList').innerHTML = filteredProducts.map(p => `
            <div class="shop-item" onclick="buyForSelf(${p.id})">
                <div class="shop-img">${p.image}</div>
                <div class="shop-info">
                    <div class="shop-name">${p.name}</div>
                    <div class="shop-price">¥ ${p.price}</div>
                    <div class="shop-action">购买</div>
                </div>
            </div>
        `).join('');
    }

    // Chats List
    if($('chatList')) {
        let filteredChats = state.chats;
        if(state.activeChatGroup !== 'All') {
            filteredChats = state.chats.filter(c => {
                const f = state.friends.find(x=>x.id===c.targetId);
                return f && (f.group || 'Friends') === state.activeChatGroup;
            });
        }
        
        if (filteredChats.length === 0) {
            $('chatList').innerHTML = `<div style="text-align:center;margin-top:50px;color:#999;font-size:13px;">该分组暂无聊天</div>`;
        } else {
            $('chatList').innerHTML = filteredChats.map(c => {
                let name = 'Unknown';
                let avatar = '';
                
                if (c.isGroup) {
                    if (c.name) {
                        name = c.name;
                    } else {
                        const memberNames = (c.members || []).map(mid => {
                            const m = state.friends.find(f => f.id === mid);
                            return m ? m.name : 'Unknown';
                        });
                        name = memberNames.slice(0, 3).join(', ') + (memberNames.length > 3 ? '...' : '');
                    }
                    name += ` (${(c.members || []).length + 1})`;
                    // Group Icon
                    avatar = c.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=fee500&color=3c1e1e`; 
                } else {
                    const f = state.friends.find(x=>x.id===c.targetId) || {name:'Unknown',avatar:''};
                    name = f.name;
                    avatar = f.avatar;
                }

                return `
                    <div class="profile-item" onclick="openChat('${c.id}')">
                        <img class="avatar" src="${avatar}">
                        <div class="profile-info">
                            <div class="profile-name" style="display:flex;justify-content:space-between;">
                                <span>${name}</span> <span style="font-size:11px;color:#999;font-weight:normal;">刚刚</span>
                            </div>
                            <div class="profile-status" style="color:#888;">${c.lastMessage||''}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    }
}

// Render Gift Drawer List
function renderGiftList() {
    const cats = [
        {id:'all', name:'全部'},
        {id:'food', name:'美食'},
        {id:'beauty', name:'美妆'},
        {id:'fashion', name:'穿搭'},
        {id:'lifestyle', name:'生活'}
    ];
    
    if($('giftCategoryBar')) {
        $('giftCategoryBar').innerHTML = cats.map(c => `
            <div onclick="switchGiftCategory('${c.id}')" 
                 style="padding:8px 16px;border-radius:18px;font-size:13px;white-space:nowrap;cursor:pointer;transition:all 0.2s;
                 ${activeGiftCategory===c.id ? 'background:#333;color:#fff;font-weight:600;' : 'background:#fff;color:#666;border:1px solid #eee;'}">
                ${c.name}
            </div>
        `).join('');
    }

    const filtered = activeGiftCategory === 'all' 
        ? products 
        : products.filter(p => p.category === activeGiftCategory);

    if($('giftList')) {
        $('giftList').innerHTML = filtered.map(p => `
            <div class="shop-item" onclick="sendGift(${p.id})">
                <div class="shop-img">${p.image}</div>
                <div class="shop-info">
                    <div class="shop-name" style="font-size:12px;">${p.name}</div>
                    <div class="shop-price" style="font-size:13px;">¥ ${p.price}</div>
                    <div class="shop-action" style="font-size:11px;padding:5px;">赠送</div>
                </div>
            </div>
        `).join('');
    }
}

window.setChatGroup = (g) => {
    state.activeChatGroup = g;
    render();
};

// GROUP MANAGEMENT (NEW UI-BASED)
let editingGroupName = null;

window.openGroupManager = () => {
    const container = $('groupListContainer');
    if (!container) return;

    const groups = state.groups || [];
    container.innerHTML = groups.map(g => {
        const members = state.friends.filter(f => (f.group || DEFAULTS.groups[0]) === g);
        return `
            <div class="group-card" onclick="openGroupEditor('${g}')">
                <div class="group-item">
                    <span>${g}</span>
                    <span style="font-size:13px;color:#888;">${members.length}人 ›</span>
                </div>
            </div>
        `;
    }).join('');

    $('groupManagerPage').classList.add('active');
};

window.openGroupEditor = (groupName) => {
    editingGroupName = groupName;
    const nameInput = $('groupEditorName');
    const memberList = $('groupEditorMemberList');
    if (!nameInput || !memberList) return;

    nameInput.value = groupName;

    memberList.innerHTML = state.friends.map(f => {
        const isChecked = (f.group || DEFAULTS.groups[0]) === groupName;
        return `
            <div class="profile-item" style="padding: 10px; background: #fff; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center;">
                <img class="avatar" src="${f.avatar}" style="width: 40px; height: 40px;">
                <div class="profile-info" style="flex-grow: 1;">
                    <div class="profile-name">${f.name}</div>
                </div>
                <label class="checkbox-container">
                    <input type="checkbox" class="group-member-checkbox" data-friend-id="${f.id}" ${isChecked ? 'checked' : ''}>
                    <span class="checkmark"></span>
                </label>
            </div>
        `;
    }).join('');

    $('groupEditorPage').classList.add('active');
};

window.saveGroupEdit = () => {
    if (!editingGroupName) return;

    const newName = $('groupEditorName').value.trim();
    if (!newName) {
        alert("分组名称不能为空！");
        return;
    }

    // Update group name if changed
    if (newName !== editingGroupName) {
        const index = state.groups.indexOf(editingGroupName);
        if (index > -1) {
            state.groups[index] = newName;
        }
        state.friends.forEach(f => {
            if (f.group === editingGroupName) {
                f.group = newName;
            }
        });
    }

    // Update members based on checkboxes
    document.querySelectorAll('.group-member-checkbox').forEach(checkbox => {
        const friendId = checkbox.dataset.friendId;
        const friend = state.friends.find(f => f.id === friendId);
        if (friend) {
            if (checkbox.checked) {
                friend.group = newName;
            } else if (friend.group === newName) {
                friend.group = DEFAULTS.groups[0]; 
            }
        }
    });

    save();
    closeModal('groupEditorPage');
    openGroupManager();
    alert("分组已保存！");
};

window.addNewGroup = () => {
    const name = prompt("请输入新分组名称:");
    if (name && name.trim() && !state.groups.includes(name.trim())) {
        state.groups.push(name.trim());
        save();
        openGroupManager();
    } else if (!name || !name.trim()) {
        alert("分组名称不能为空。");
    } else {
        alert("该分组已存在。");
    }
};

window.deleteCurrentGroup = () => {
    if (!editingGroupName) return;
    if (state.groups.length <= 1) {
        alert("必须保留至少一个分组。");
        return;
    }

    if (confirm(`确定要删除分组 "${editingGroupName}" 吗？\n该分组的成员将被移至默认分组。`)) {
        const defaultGroup = DEFAULTS.groups[0] || 'Friends';
        state.friends.forEach(f => {
            if (f.group === editingGroupName) {
                f.group = defaultGroup;
            }
        });

        state.groups = state.groups.filter(g => g !== editingGroupName);
        
        save();
        closeModal('groupEditorPage');
        openGroupManager();
        alert("分组已删除。");
    }
};

// THEME LOGIC
window.openTheming = () => {
    $('colorMeBg').value = themeConfig.meBg;
    $('colorMeText').value = themeConfig.meText;
    $('colorOtherBg').value = themeConfig.otherBg;
    $('colorOtherText').value = themeConfig.otherText;
    
    // Set link inputs if they are URLs
    if(themeConfig.meImg && !themeConfig.meImg.startsWith('data:')) $('linkMeBg').value = themeConfig.meImg;
    if(themeConfig.otherImg && !themeConfig.otherImg.startsWith('data:')) $('linkOtherBg').value = themeConfig.otherImg;
    
    applyTheme(); 
    $('modalTheming').classList.add('active');
};

window.updateTheme = (key, val) => {
    themeConfig[key] = val;
    applyTheme();
    localStorage.setItem('kt_theme_config', JSON.stringify(themeConfig));
};

window.handleThemeFile = (input, key) => {
    if(input.files[0]) {
        const r = new FileReader();
        r.onload = v => updateTheme(key, v.target.result);
        r.readAsDataURL(input.files[0]);
    }
};

window.handleFile = (e, type) => {
    const file = e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = function(evt) {
        if(type === 'avatar') {
            $('editAvatarPreview').src = evt.target.result;
        } else if(type === 'bg') {
            $('editBgPreview').src = evt.target.result;
            $('bgUploadContainer').style.display = 'block';
        }
    };
    r.readAsDataURL(file);
    e.target.value = '';
};

window.handleProfileBg = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = function(evt) {
        const newBg = evt.target.result;
        
        // Update current viewed profile immediately
        const mp = $('modalProfile');
        mp.style.backgroundImage = `url(${newBg})`;
        mp.style.backgroundColor = 'transparent';

        // Save to state
        if(curProfileId === 'me') {
            state.user.bgImage = newBg;
        } else if(curProfileId) {
            const f = state.friends.find(x => x.id === curProfileId);
            if(f) f.bgImage = newBg;
        }
        save();
    };
    r.readAsDataURL(file);
    e.target.value = '';
};

window.handleProfileEditFile = (input, type) => {
    if(input.files && input.files[0]) {
        const r = new FileReader();
        r.onload = v => {
            if(type === 'avatar') {
                $('pfAvatar').src = v.target.result;
                window.tempNewAvatar = v.target.result;
            } else if(type === 'bg') {
                const mp = $('modalProfile');
                mp.style.backgroundImage = `url(${v.target.result})`;
                mp.style.backgroundColor = 'transparent';
                window.tempNewBg = v.target.result;
            }
        };
        r.readAsDataURL(input.files[0]);
    }
    input.value = '';
};

window.resetProfileBg = () => {
    if(confirm('确定要移除自定义背景恢复默认深灰色吗？')) {
        const mp = $('modalProfile');
        mp.style.backgroundImage = 'none';
        mp.style.backgroundColor = '#545b66';
        window.tempNewBg = ''; 
    }
};

window.resetTheme = () => {
    themeConfig = { globalBg:'', chatBg:'', meBg:'#fee500', meText:'#000000', meImg:'', otherBg:'#ffffff', otherText:'#000000', otherImg:'' };
    applyTheme();
    localStorage.setItem('kt_theme_config', JSON.stringify(themeConfig));
    $('colorMeBg').value = '#fee500'; $('colorMeText').value = '#000000';
    $('colorOtherBg').value = '#ffffff'; $('colorOtherText').value = '#000000';
    if($('linkMeBg')) $('linkMeBg').value = ''; 
    if($('linkOtherBg')) $('linkOtherBg').value = '';
};

function applyTheme() {
    const r = document.documentElement;
    if(themeConfig.globalBg) {
        document.querySelector('.screen').style.backgroundImage = `url(${themeConfig.globalBg})`;
    } else {
        document.querySelector('.screen').style.backgroundImage = 'none';
    }
    const chatBgRule = themeConfig.chatBg ? `url(${themeConfig.chatBg}) center/cover` : 'var(--chat-bg)';
    r.style.setProperty('--real-chat-bg', chatBgRule);
    r.style.setProperty('--msg-bg-me', themeConfig.meImg ? `url(${themeConfig.meImg})` : themeConfig.meBg);
    r.style.setProperty('--msg-color-me', themeConfig.meText);
    r.style.setProperty('--msg-bg-other', themeConfig.otherImg ? `url(${themeConfig.otherImg})` : themeConfig.otherBg);
    r.style.setProperty('--msg-color-other', themeConfig.otherText);

    const p = $('previewChatBg');
    if(p) {
        p.style.background = chatBgRule;
        $('previewBubbleMe').style.background = themeConfig.meImg ? `url(${themeConfig.meImg}) center/cover` : themeConfig.meBg;
        $('previewBubbleMe').style.color = themeConfig.meText;
        $('previewBubbleOther').style.background = themeConfig.otherImg ? `url(${themeConfig.otherImg}) center/cover` : themeConfig.otherBg;
        $('previewBubbleOther').style.color = themeConfig.otherText;
    }
    const room = $('chatRoom');
    if(room) room.style.background = chatBgRule;
}

// PROFILE
let curProfileId = null;
window.tempNewAvatar = null;
window.tempNewBg = null;

window.openProfile = (userOrId) => {
    const isMe = userOrId === 'me';
    const user = isMe ? state.user : (typeof userOrId === 'string' ? state.friends.find(f=>f.id===userOrId) : userOrId);
    if(!user) return;
    curProfileId = user.id;

    // Reset temp vars
    window.tempNewAvatar = null;
    window.tempNewBg = null;

    // Reset to view mode
    toggleProfileEditMode(false);

    // Fill View Data
    $('pfAvatar').src = user.avatar;
    $('pfName').innerText = user.name;
    $('pfStatus').innerText = user.status || '';
    
    // Fill Edit Data
    $('pfNameInput').value = user.name;
    $('pfStatusInput').value = user.status || '';
    
    const bg = user.bgImage || '#545b66';
    const mp = $('modalProfile');
    mp.style.backgroundImage = bg.startsWith('http') || bg.startsWith('data:') ? `url(${bg})` : 'none';
    mp.style.backgroundColor = bg.startsWith('http') || bg.startsWith('data:') ? 'transparent' : bg;

    const topRight = $('pfTopRightActions');
    const footer = $('pfFooter');
    
    // SVG Icons
    const icons = {
        chat: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
        edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
        call: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.05 12.05 0 0 0 .57 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.05 12.05 0 0 0 2.81.57A2 2 0 0 1 22 16.92z"></path></svg>',
        video: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px;"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>',
        more: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:24px;height:24px;"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>',
        settings: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>'
    };

    if(isMe) {
        topRight.innerHTML = `
            <div onclick="toggleProfileEditMode(true)" style="cursor:pointer;">${icons.edit}</div>
            <div style="cursor:pointer;opacity:0.5;">${icons.more}</div>
        `;
        footer.innerHTML = `
            <div class="pf-action-box">
                <div class="pf-box-btn" onclick="startChat('me')">
                    ${icons.chat} 我的聊天室
                </div>
                <div class="pf-box-sep"></div>
                <div class="pf-box-btn" onclick="alert('发布新动态...')">
                    ${icons.edit} New Post
                </div>
            </div>
        `;
    } else {
        topRight.innerHTML = `
            <div onclick="toggleProfileEditMode(true)" style="cursor:pointer;">${icons.edit}</div>
            <div style="cursor:pointer;opacity:0.5;">${icons.more}</div>
        `;
        footer.innerHTML = `
            <div class="pf-action-box">
                <div class="pf-box-btn" onclick="startChat('${user.id}')">
                    ${icons.chat} 聊天
                </div>
                <div class="pf-box-sep"></div>
                <div class="pf-box-btn" onclick="showCallOption()">
                    ${icons.call} 通话
                </div>
            </div>
        `;
    }
    
    mp.classList.add('active');
};

window.toggleProfileEditMode = (isEditing) => {
    // View Elements
    const viewActions = $('pfViewActions');
    const name = $('pfName');
    const status = $('pfStatus');
    const footer = $('pfFooter');
    
    // Edit Elements
    const editActions = $('pfEditActions');
    const nameEdit = $('pfNameEdit');
    const statusEdit = $('pfStatusEdit');
    const footerEdit = $('pfEditFooter');
    const avatarBadge = $('pfAvatarEditBadge');
    
    if(isEditing) {
        viewActions.style.display = 'none';
        name.style.display = 'none';
        status.style.display = 'none';
        footer.style.display = 'none';
        
        editActions.style.display = 'flex';
        nameEdit.style.display = 'flex';
        statusEdit.style.display = 'flex';
        footerEdit.style.display = 'flex';
        avatarBadge.style.display = 'flex';
    } else {
        viewActions.style.display = 'flex';
        name.style.display = 'block';
        status.style.display = 'block';
        footer.style.display = 'block';
        
        editActions.style.display = 'none';
        nameEdit.style.display = 'none';
        statusEdit.style.display = 'none';
        footerEdit.style.display = 'none';
        avatarBadge.style.display = 'none';
    }
};

window.cancelProfileEdit = () => {
    openProfile(curProfileId); // Revert changes
};

window.saveProfileChanges = () => {
    const name = $('pfNameInput').value;
    const status = $('pfStatusInput').value;
    
    let user;
    if(curProfileId === 'me') {
        user = state.user;
    } else {
        user = state.friends.find(x => x.id === curProfileId);
    }
    
    if(user) {
        user.name = name;
        user.status = status;
        if(window.tempNewAvatar) {
            user.avatar = window.tempNewAvatar;
            window.tempNewAvatar = null;
        }
        if(window.tempNewBg !== null && window.tempNewBg !== undefined) {
            user.bgImage = window.tempNewBg;
            window.tempNewBg = null;
        }
        save();
        
        // Update View Text
        $('pfName').innerText = name;
        $('pfStatus').innerText = status;
        
        // Update Lists
        render();
    }
    
    toggleProfileEditMode(false);
};

// SETTINGS DRAWER
window.openFriendSettings = (fid) => {
    closeModal('modalProfile');
    const f = state.friends.find(x=>x.id===fid);
    curProfileId = fid;

    $('sdAvatar').src = f.avatar;
    $('sdName').innerText = f.name;
    $('sdPersona').innerText = f.persona || '默认';

    $('drawerSettings').classList.add('active');
};

// NEW: Contact Edit (Simplified)
window.openContactEdit = (isMe, fid) => {
    editingId = fid;
    closeModal('drawerSettings');
    
    const f = state.friends.find(x=>x.id===fid);
    if(!f) return;

    $('contactEditName').value = f.name;
    $('contactEditStatus').value = f.status || '';
    $('contactEditAvatarPreview').src = f.avatar;
    loadWorldOptions('contactEditWorld', f.worldviewId || '');
    
    const editor = $('modalContactEdit');
    editor.style.zIndex = '6000'; 
    editor.classList.add('active');
}

window.handleContactFile = (input) => {
    if(input.files[0]) {
        const r = new FileReader();
        r.onload = v => {
            $('contactEditAvatarPreview').src = v.target.result;
        };
        r.readAsDataURL(input.files[0]);
    }
};

// Buy for Self (Backpack)
window.buyForSelf = (pid) => {
    const p = products.find(x=>x.id===pid);
    if(!p) return;
    
    if(state.wallet.balance < p.price) {
        alert("余额不足！");
        return;
    }
    
    if(confirm(`确定购买 ${p.name} (¥${p.price}) 放入自己的物品栏吗?`)) {
        state.wallet.balance -= p.price;
        if(!state.user.items) state.user.items = []; // Initialize if not present
        state.user.items.push(p.id); // Add item ID
        save();
        alert("购买成功！已放入“我的物品”。");
    }
};

// NEW: Open My Items Page
window.openMyItemsPage = () => {
    const container = $('myItemsList');
    if(!container) return;

    const myItemIds = state.user.items || [];
    if (myItemIds.length === 0) {
        container.innerHTML = `<div style="text-align:center;margin-top:100px;color:#999;font-size:14px;">你的物品栏是空的</div>`;
    } else {
        const myProducts = myItemIds.map(id => products.find(p => p.id === id)).filter(Boolean);
        container.innerHTML = myProducts.map(p => `
            <div class="shop-item">
                <div class="shop-img">${p.image}</div>
                <div class="shop-info">
                    <div class="shop-name">${p.name}</div>
                    <div class="shop-price">购买价格: ¥ ${p.price}</div>
                </div>
            </div>
        `).join('');
    }

    $('drawerMyItems').classList.add('active');
};

// Open Gift Select Drawer (Chat Room)
window.openGiftSelect = () => {
    if(!activeChatId) return;
    renderGiftList();
    $('drawerGift').classList.add('active');
};

// Send Gift (Chat Room)
window.sendGift = (pid) => {
    const p = products.find(x=>x.id===pid);
    if(!p || !activeChatId) return;
    
    const chat = state.chats.find(c => c.id === activeChatId);
    if(!chat) return;
    
    if(state.wallet.balance < p.price) {
        alert("余额不足！");
        return;
    }
    
    if(confirm(`确定赠送 ${p.name} (¥${p.price}) 吗?`)) {
        state.wallet.balance -= p.price;
        
        const msg = {
            id: Date.now(),
            sender: 'me',
            text: `[礼物] ${p.name}`,
            type: 'gift',
            info: { name: p.name, image: p.image, price: p.price },
            time: new Date().toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'})
        };
        chat.messages.push(msg);
        chat.lastMessage = `[礼物] ${p.name}`;
        chat.lastTime = Date.now();
        
        // Move chat to top
        state.chats = state.chats.filter(c => c.id !== chat.id);
        state.chats.unshift(chat);
        
        save();
        if(typeof renderMsg === 'function') renderMsg(msg, getActiveFriend());
        closeModal('drawerGift');
    }
};

window.openFriendEditor = (isMe, fid) => {
    editingId = fid; 
    isCreatingMask = false; 

    if (fid) {
        // Edit existing
        const f = isMe ? state.user : state.friends.find(x => x.id === fid);
        if (!f) return;

        $('editorTitle').innerText = isMe ? '编辑我的资料' : '编辑好友';
        $('editName').value = f.name;
        $('editStatus').value = f.status || '';
        $('editPersona').value = f.persona || '';
        $('editAvatarPreview').src = f.avatar;
        $('editBgPreview').src = f.bgImage || '';
        if(f.bgImage) $('bgUploadContainer').style.display = 'block';
        else $('bgUploadContainer').style.display = 'none';

        if ($('editLang')) $('editLang').value = f.language || '';
        if ($('editRelation')) $('editRelation').value = f.relation || '';
        if ($('editGreeting')) $('editGreeting').value = f.greeting || '';
        if ($('editMaskId')) $('editMaskId').value = f.maskId || '';
        loadWorldOptions('editWorld', f.worldviewId || '');
    } else {
        // Add new friend
        $('editorTitle').innerText = '添加新好友';
        $('editName').value = '';
        $('editStatus').value = '';
        $('editPersona').value = '';
        $('editAvatarPreview').src = 'https://ui-avatars.com/api/?name=New+Friend&background=random';
        $('editBgPreview').src = '';
        $('bgUploadContainer').style.display = 'none';

        if ($('editLang')) $('editLang').value = '';
        if ($('editRelation')) $('editRelation').value = '';
        if ($('editGreeting')) $('editGreeting').value = '';
        if ($('editMaskId')) $('editMaskId').value = '';
        loadWorldOptions('editWorld', '');
    }

    const editor = $('modalEditor');
    editor.style.zIndex = '6000';
    editor.classList.add('active');
};

window.saveContactEdit = () => {
    const name = $('contactEditName').value;
    const status = $('contactEditStatus').value;
    const avatar = $('contactEditAvatarPreview').src;
    const worldId = $('contactEditWorld').value;

    if (!name.trim()) { alert('请输入名字'); return; }

    const f = state.friends.find(x=>x.id===editingId);
    if(f) {
        f.name = name; 
        f.status = status; 
        f.avatar = avatar;
        f.worldviewId = worldId;
    }

    save();
    closeModal('modalContactEdit');
    if(curProfileId) openProfile(curProfileId);
};

window.saveEditor = () => {
    const name = $('editName').value;
    const status = $('editStatus').value;
    const persona = $('editPersona').value;
    const avatar = $('editAvatarPreview').src;
    const bg = $('editBgPreview').src;
    
    // New fields
    const lang = $('editLang') ? $('editLang').value : '';

    // Validation
    if (!name.trim()) { alert('请输入名字'); return; }
    const relation = $('editRelation') ? $('editRelation').value : '';
    const greeting = $('editGreeting') ? $('editGreeting').value : '';
    const maskId = $('editMaskId') ? $('editMaskId').value : '';
    const worldId = $('editWorld') ? $('editWorld').value : '';

    if(isCreatingMask) {
        if(!state.user.masks) state.user.masks = [];
        const newMask = { id:'m'+Date.now(), name, status, avatar, bgImage:bg };
        state.user.masks.push(newMask);
        state.user.name = name; state.user.status = status; state.user.avatar = avatar; state.user.bgImage = bg;
        save();
        closeModal('modalEditor');
        openMasks();
        return;
    }
    
    if(editingId === 'me') {
        state.user = { ...state.user, name, status, avatar, bgImage:bg };
    } else if(editingId) {
        const f = state.friends.find(x=>x.id===editingId);
        if(f) {
            f.name = name; f.status = status; f.persona = persona; f.avatar = avatar; f.bgImage = bg;
            f.language = lang; f.relation = relation; f.greeting = greeting; f.maskId = maskId; f.worldviewId = worldId;
        }
    } else {
        // Create new friend
        state.friends.push({ 
            id:'f'+Date.now(), name, status, persona, avatar, bgImage:bg, gallery:[],
            language: lang, relation: relation, greeting: greeting, maskId: maskId, worldviewId: worldId,
            group: 'Friends' // Default group
        });
    }
    save();
    closeModal('modalEditor');
    if(curProfileId) openProfile(curProfileId);
};

window.deleteFriend = () => {
    state.friends = state.friends.filter(x=>x.id!==curProfileId);
    state.chats = state.chats.filter(c=>c.targetId!==curProfileId);
    save();
    closeModal('drawerSettings');
};

// MASKS
let isCreatingMask = false;
window.openMasks = () => {
    const masks = state.user.masks || [];
    let html = masks.map(m => `
        <div class="mask-item ${m.name === state.user.name ? 'active' : ''}" onclick="switchMask('${m.id}')">
            <img src="${m.avatar}" class="avatar">
            <div style="flex:1;">
                <div style="font-weight:600;">${m.name}</div>
                <div style="font-size:12px;color:#888;">${m.status || '无状态'}</div>
            </div>
            ${m.name === state.user.name ? '✅' : ''}
        </div>
    `).join('');
    html += `<div class="mask-add" onclick="createMask()"><span>+</span> 创建新面具</div>`;
    $('maskList').innerHTML = html;
    const maskModal = $('modalMasks');
    maskModal.style.zIndex = '6000'; 
    maskModal.classList.add('active');
};

window.switchMask = (mid) => {
    const m = state.user.masks.find(x=>x.id===mid);
    if(m) {
        state.user.name = m.name;
        state.user.status = m.status;
        state.user.avatar = m.avatar;
        state.user.bgImage = m.bgImage;
        save();
        closeModal('modalMasks');
        if(curProfileId === 'me') openProfile('me');
    }
};

window.createMask = () => {
    isCreatingMask = true;
    $('editorTitle').innerText = '创建新面具';
    $('editName').value = '';
    $('editStatus').value = '';
    $('editPersona').value = '';
    $('editAvatarPreview').src = 'https://ui-avatars.com/api/?name=New+Mask&background=random';
    $('bgUploadContainer').style.display = 'none';
    
    if($('editLang')) $('editLang').value = '';
    if($('editRelation')) $('editRelation').value = '';
    if($('editGreeting')) $('editGreeting').value = '';
    if($('editMaskId')) $('editMaskId').value = '';
    loadWorldOptions('editWorld', '');

    const editor = $('modalEditor');
    editor.style.zIndex = '6500'; 
    editor.classList.add('active');
};

window.editPersona = () => {
    const f = state.friends.find(x=>x.id===curProfileId);
    openFriendEditor(false, f.id);
}

window.openVoiceEditor = () => {
    const v = $('viewVoiceClone');
    v.style.zIndex = '6500';
    v.classList.add('active');
}

// CHAT
let activeChatId = null;
window.openChat = (cid) => {
    activeChatId = cid;
    const c = state.chats.find(x=>x.id===cid);
    
    let title = '';
    let targetUser = null;

    if (c.isGroup) {
        // Group Chat Logic
        if (c.name) {
            title = c.name;
        } else {
            // Auto-generate name from members
            const memberNames = c.members.map(mid => {
                const m = state.friends.find(f => f.id === mid);
                return m ? m.name : '未知用户';
            });
            title = memberNames.join(', ');
            if (title.length > 20) title = title.substring(0, 20) + '...';
        }
        title += ` (${c.members.length + 1})`; // +1 for me
    } else {
        // 1:1 Chat Logic
        targetUser = state.friends.find(x=>x.id===c.targetId) || {name:'Unknown',avatar:''};
        title = targetUser.name;
    }
    
    $('chatTitle').innerText = title;
    $('chatMsgs').innerHTML = '';
    
    c.messages.forEach(m => {
        if (c.isGroup && m.sender !== 'me') {
            const senderProfile = state.friends.find(f => f.id === m.sender) || {name:'Unknown',avatar:''};
            renderMsg(m, senderProfile);
        } else {
            renderMsg(m, targetUser);
        }
    });
    
    applyTheme();
    $('chatRoom').classList.add('active');
};

function getActiveFriend() {
    if(!activeChatId) return null;
    const c = state.chats.find(x=>x.id===activeChatId);
    if(!c) return null;
    if(c.isGroup) return null; // Group chats don't have a single active friend context in the same way
    return state.friends.find(x=>x.id===c.targetId);
}

window.startChat = (fid) => {
    closeModal('modalProfile');
    let c = state.chats.find(x=>x.targetId===fid);
    if(!c) {
        c = { id:'c'+Date.now(), targetId:fid, messages:[] };
        state.chats.push(c);
    }
    openChat(c.id);
};

window.sendMsg = (payload) => {
    const c = state.chats.find(x=>x.id===activeChatId);
    let f = null;
    if (!c.isGroup) {
        f = state.friends.find(x=>x.id===c.targetId);
    }
    
    if(payload && typeof payload === 'object' && payload.type) {
        const msg = { sender: 'me', time: Date.now(), ...payload };
        let lastText = '';
        if(payload.type === 'image') lastText = '[图片]';
        else if(payload.type === 'transfer') lastText = '[转账]';
        else if(payload.type === 'location') lastText = '[位置]';
        else if(payload.type === 'gift') lastText = '[礼物] ' + payload.content;
        
        c.messages.push(msg);
        c.lastMessage = lastText;
        save();
        renderMsg(msg, f);
    } else {
        const txt = $('chatInput').value;
        if(!txt) return;
        
        const msg = { sender:'me', text:txt, time:Date.now() };
        c.messages.push(msg);
        c.lastMessage = txt;
        save();
        $('chatInput').value = '';
        renderMsg(msg, f);

        if(window.checkGiftTrigger && f) {
            window.checkGiftTrigger(txt, f.id);
        }

        // Trigger AI
        if(f && !c.isGroup) {
            triggerAIResponse(c.id, f);
        }
    }
};

function formatKakaoTime(ts) {
    const d = new Date(ts);
    let hour = d.getHours();
    const minute = d.getMinutes().toString().padStart(2, '0');
    const period = hour >= 12 ? '下午' : '上午';
    if (hour > 12) hour -= 12;
    if (hour === 0) hour = 12;
    return `${period} ${hour}:${minute}`;
}

function renderMsg(msg, friend) {
    const isMe = msg.sender === 'me';
    const d = document.createElement('div');
    d.id = `msg-${msg.id}`;
    const isBlocked = !isMe && friend && friend.blocked;
    d.className = `msg-row ${isMe?'mine':''} ${isBlocked?'blocked':''}`;
    
    // Simulation Logic: My messages are unread ('1') until AI replies/reads.
    // AI messages are always read.
    const showUnread = isMe && msg.unread !== false;

    let profileHtml = '';
    if (!isMe) {
        const name = friend ? friend.name : 'Unknown';
        const avatar = friend ? friend.avatar : '';
        profileHtml = `
            <div style="display:flex;flex-direction:column;align-items:flex-start;margin-right:8px;">
                <img style="width:36px;height:36px;border-radius:14px;background:#fff;margin-bottom:4px;object-fit:cover;" src="${avatar}" onclick="openProfile('${friend ? friend.id : ''}')">
                <span style="font-size:12px;color:#666;margin-left:2px;margin-bottom:2px;">${name}</span>
            </div>
        `;
    }

    let content = '';
    let bubbleStyle = '';

    if(msg.type === 'image' || (msg.image && msg.type !== 'gift')) {
        content = `<img src="${msg.image || msg.content}" style="max-width:200px;border-radius:10px;display:block;" onclick="viewImage('${msg.image || msg.content}')">`;
    } else if(msg.type === 'transfer') {
        content = `
            <div style="min-width:180px;">
                <div style="font-weight:bold;margin-bottom:5px;">转账</div>
                <div style="font-size:18px;font-weight:bold;color:#3c1e1e;">¥ ${msg.amount}</div>
                <div style="font-size:12px;color:#666;margin-top:5px;border-top:1px solid rgba(0,0,0,0.1);padding-top:5px;">Kakao Pay</div>
            </div>
        `;
    } else if(msg.type === 'location') {
        content = `
            <div style="min-width:180px;">
                <div style="font-weight:bold;margin-bottom:5px;">位置分享</div>
                <div style="font-size:14px;color:#333;">${msg.address}</div>
                <div style="height:80px;background:#eee;margin-top:5px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;">[地图预览]</div>
            </div>
        `;
    } else if(msg.type === 'gift') {
        bubbleStyle = 'padding:0; background:transparent !important; box-shadow:none;';
        content = `
            <div class="msg-gift-card">
                <div class="shop-img" style="height:140px; border-radius:8px; margin-bottom:10px;">${msg.image}</div>
                <div class="msg-gift-tag">礼物</div>
                <div style="font-weight:600;margin-bottom:5px;">${msg.content}</div>
                <div class="msg-gift-btn">查看礼物</div>
            </div>
        `;
    } else if(msg.type === 'redpacket') {
        bubbleStyle = 'padding:0; background:transparent !important; box-shadow:none;';
        const isClaimed = msg.status === 'claimed';
        content = `
            <div onclick="viewRedPacket('${msg.id}')" style="background:#fa9d3b; border-radius:12px; overflow:hidden; width:220px; cursor:pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                <div style="padding:15px; display:flex; align-items:center; gap:10px;">
                    <div style="width:40px; height:40px; background:#fceea8; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fa9d3b; font-weight:bold; font-size:20px;">¥</div>
                    <div style="flex:1; min-width:0;">
                        <div style="color:#fff; font-size:14px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${msg.content || '恭喜发财'}</div>
                        <div style="color:rgba(255,255,255,0.8); font-size:12px; margin-top:2px;">${isClaimed ? '已领取' : '查看红包'}</div>
                    </div>
                </div>
                <div style="background:#fff; padding:10px 15px; font-size:11px; color:#999; display:flex; justify-content:space-between; align-items:center;">
                    <span>Kakao Pay 红包</span>
                    <svg style="width:12px;height:12px;opacity:0.5;" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
        `;
    } else {
        content = msg.text || '';
        content = content.replace(/\n/g, '<br>');
    }

    // Reasoning Display Logic
    let reasoningHtml = '';
    if (msg.reasoning) {
        // Convert newlines to breaks for display, or keep pre-wrap
        // Adding a small label
        reasoningHtml = `<div class="msg-reasoning"><strong>💭 思考过程:</strong><br>${msg.reasoning}</div>`;
    }

    const timeStr = formatKakaoTime(msg.time);

    d.innerHTML = `
        ${!isMe ? profileHtml : ''}
        <div class="msg-content-wrapper" style="flex-direction: column; align-items: ${isMe ? 'flex-end' : 'flex-start'};">
            ${reasoningHtml}
            <div style="display: flex; flex-direction: ${isMe ? 'row-reverse' : 'row'}; align-items: flex-end; gap: 4px;">
                <div class="msg-bubble">${content}</div>
                <div class="msg-meta">
                    ${showUnread ? '<span class="msg-unread">1</span>' : ''}
                    <span class="msg-time">${timeStr}</span>
                </div>
            </div>
        </div>
    `;
    
    // Original structure was:
    /*
    <div class="msg-content-wrapper">
        <div class="msg-bubble">${content}</div>
        <div class="msg-meta">...</div>
    </div>
    */
    // Since I changed the structure to support reasoning block above the bubble, I adjusted the inner HTML.
    // However, I need to make sure I didn't break the original layout too much.
    // The original CSS for .msg-content-wrapper was:
    /*
    .msg-content-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 4px;
        max-width: 100%;
    }
    .msg-row.mine .msg-content-wrapper {
        flex-direction: row-reverse;
    }
    */
    // My new structure changes .msg-content-wrapper to column to stack reasoning and (bubble+meta).
    // Let's adjust the replace block to be more robust.
    
    /* 
       New Plan for d.innerHTML:
       Keep outer msg-content-wrapper but maybe override style inline or change class structure if needed.
       Actually, simply wrapping reasoning + (bubble+meta row) in a column div inside the wrapper works best.
       But wait, the profile image is OUTSIDE msg-content-wrapper.
       
       Structure:
       d (flex row)
         -> profileHtml (img)
         -> msg-content-wrapper (flex row/row-reverse) -> bubble, meta
       
       If I want reasoning above bubble, I should probably wrap bubble+meta in a column OR wrap reasoning+bubble in a column and meta on side?
       Usually reasoning is part of the message "block".
       
       Let's try:
       d (flex row)
         -> profileHtml
         -> Container (Flex Column)
            -> Reasoning Box
            -> Inner Wrapper (Flex Row for bubble + meta)
       
       This Container effectively replaces msg-content-wrapper's role as the main content holder, but msg-content-wrapper CSS handles the bubble/meta alignment.
    */
    
    const innerContent = `
        <div style="display:flex; flex-direction:column; align-items:${isMe ? 'flex-end' : 'flex-start'}; max-width:100%;">
            ${reasoningHtml}
            <div class="msg-content-wrapper">
                <div class="msg-bubble" style="${bubbleStyle}">${content}</div>
                <div class="msg-meta">
                    ${showUnread ? '<span class="msg-unread">1</span>' : ''}
                    <span class="msg-time">${timeStr}</span>
                </div>
            </div>
        </div>
    `;

    d.innerHTML = `
        ${!isMe ? profileHtml : ''}
        ${innerContent}
    `;
    
    /* Wait, .msg-row has flex. 
       .msg-row.mine has flex-direction: row-reverse.
       
       If I insert a div wrapper, it will be the flex child.
       
       If !isMe:
       [Profile] [Container]
       
       If isMe:
       [Container]
       
       Inside Container:
       [Reasoning]
       [Bubble + Meta]
       
       This seems correct. I need to make sure .msg-content-wrapper inside the Container still behaves.
       .msg-content-wrapper CSS: 
         display: flex; align-items: flex-end; gap: 4px; max-width: 100%;
       .msg-row.mine .msg-content-wrapper:
         flex-direction: row-reverse;
         
       Yes, this CSS selector `.msg-row.mine .msg-content-wrapper` will still target the inner wrapper correctly.
       
       So the replacement is:
    */
    
    d.innerHTML = `
        ${!isMe ? profileHtml : ''}
        <div style="display:flex; flex-direction:column; align-items:${isMe ? 'flex-end' : 'flex-start'}; max-width:100%;">
            ${reasoningHtml}
            <div class="msg-content-wrapper">
                <div class="msg-bubble">${content}</div>
                <div class="msg-meta">
                    ${showUnread ? '<span class="msg-unread">1</span>' : ''}
                    <span class="msg-time">${timeStr}</span>
                </div>
            </div>
        </div>
    `;
    $('chatMsgs').appendChild(d);
    $('chatMsgs').scrollTop = $('chatMsgs').scrollHeight;
}

// CHAT SETTINGS PAGE LOGIC
window.toggleChatDrawer = () => {
    const p = $('chatSettingsPage');
    const isActive = p.classList.contains('active');
    if(!isActive) {
        renderChatSettings();
        p.classList.add('active');
    } else {
        p.classList.remove('active');
    }
};

let currentCalYear = new Date().getFullYear();
let currentCalMonth = new Date().getMonth();

function renderChatSettings() {
    if(!activeChatId) return;
    const c = state.chats.find(x=>x.id===activeChatId);
    if(!c) return;

    // Determine Top Info
    let topName = '', topAvatar = '', topStatus = '';
    const isMeChat = c.targetId === 'me';

    if (c.isGroup) {
        topName = c.name || '群聊';
        topAvatar = c.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(topName)}&background=fee500&color=3c1e1e`;
        topStatus = `${c.members.length + 1} 成员`;
    } else if (isMeChat) {
        topName = state.user.name;
        topAvatar = state.user.avatar;
        topStatus = state.user.status || '';
    } else {
        const f = state.friends.find(x=>x.id===c.targetId);
        if(f) {
            topName = f.name;
            topAvatar = f.avatar;
            topStatus = f.status || '';
        }
    }

    if($('csAvatar')) {
        $('csAvatar').src = topAvatar;
        $('csAvatar').onclick = c.isGroup ? () => $('editGroupAvatarInput').click() : null;
    }
    if($('csName')) $('csName').innerText = topName;
    if($('csStatus')) $('csStatus').innerText = topStatus;

    // 2. Dynamic Settings List based on Type
    const settingsList = $('csSettingsList');
    if(settingsList) {
        let html = '';
        
        // Common Icons
        const iconSearch = '<svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>';
        const iconEdit = '<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'; // User/Persona
        const iconGallery = '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
        const iconLogout = '<svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>';
        const iconInvite = '<svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>';
        const iconBlock = '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>';

        if (c.isGroup) {
            // Group Chat Settings
            html += `
                <div class="cs-list-item" onclick="editChatName()">
                    <div class="cs-list-icon">${iconEdit}</div>
                    <div class="cs-list-text">修改群聊名称</div>
                </div>
                <div class="cs-list-item" onclick="alert('邀请功能开发中...')">
                    <div class="cs-list-icon">${iconInvite}</div>
                    <div class="cs-list-text">邀请好友</div>
                </div>
                <div class="cs-list-item" onclick="searchChatHistory()">
                    <div class="cs-list-icon">${iconSearch}</div>
                    <div class="cs-list-text">查找聊天记录</div>
                </div>
                <div class="cs-list-item" onclick="openChatGalleryPage()">
                    <div class="cs-list-icon">${iconGallery}</div>
                    <div class="cs-list-text">群相册</div>
                </div>
                <div class="cs-list-item" onclick="leaveGroup()">
                    <div class="cs-list-icon" style="opacity:0.5;">${iconLogout}</div>
                    <div class="cs-list-text" style="color:var(--danger);">离开群聊 (Leave)</div>
                </div>
            `;
        } else {
            // Private Chat Settings
            html += `
                <div class="cs-list-item" onclick="editChatPersona()">
                    <div class="cs-list-icon">${iconEdit}</div>
                    <div class="cs-list-text">修改人设</div>
                </div>
                <div class="cs-list-item" onclick="openChatGalleryPage()">
                    <div class="cs-list-icon">${iconGallery}</div>
                    <div class="cs-list-text">形象</div>
                </div>
                <div class="cs-list-item" onclick="searchChatHistory()">
                    <div class="cs-list-icon">${iconSearch}</div>
                    <div class="cs-list-text">查找聊天记录</div>
                </div>
            `;
        }
        settingsList.innerHTML = html;
    }

    // Participants List
    const list = $('csParticipantsList');
    if(list) {
        let members = [];
        // Add Me
        members.push({ ...state.user, isMe: true });
        
        // Add Others (Only if not "My Chatroom")
        if (!isMeChat) {
            if (c.isGroup) {
                c.members.forEach(mid => {
                    const f = state.friends.find(x=>x.id===mid);
                    if(f) members.push(f);
                });
            } else {
                const f = state.friends.find(x=>x.id===c.targetId);
                if(f) members.push(f);
            }
        }

        let html = members.map(m => `
            <div class="cs-part-row" onclick="${m.isMe ? '' : `openProfile('${m.id}')`}">
                <img src="${m.avatar}" class="cs-part-avatar">
                <div class="cs-part-info">
                    <div class="cs-part-name">${m.isMe ? '<span class="cs-me-badge" style="margin-right:6px;">me</span>' : ''}${m.name}</div>
                    <div class="cs-part-status">${m.status || ''}</div>
                </div>
            </div>
        `).join('');
        
        list.innerHTML = html;
        if($('csPartCount')) $('csPartCount').innerText = members.length;
    }
}

window.handleGalleryUpload = (input) => {
    const f = getActiveFriend();
    if(!f || !input.files.length) return;
    const files = Array.from(input.files);
    const currentLen = (f.gallery || []).length;
    // const remaining = 10 - currentLen; // Limit removed for better UX in "形象"
    // if(remaining <= 0) { alert('最多只能上传10张图片'); return; }
    
    let processed = 0;
    if(!f.gallery) f.gallery = [];
    
    files.forEach(file => {
        const r = new FileReader();
        r.onload = v => {
            f.gallery.unshift(v.target.result); // Add to top
            processed++;
            if(processed === files.length) { 
                save(); 
                // Refresh if gallery page is open
                if($('pageChatGallery').classList.contains('active')) {
                     openChatGalleryPage();
                }
                alert("上传成功");
            }
        };
        r.readAsDataURL(file);
    });
    input.value = ''; // Reset input
};

window.openChatGalleryPage = () => {
    const f = getActiveFriend();
    if(!f) return;
    
    const container = $('chatGalleryGrid');
    const gallery = f.gallery || [];
    
    if(gallery.length === 0) {
        container.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:50px;color:#999;">暂无形象照片<br>点击右上角上传</div>`;
    } else {
        container.innerHTML = gallery.map(src => `
            <div class="cs-gallery-item" style="background-image:url(${src});background-size:cover;background-position:center;" onclick="viewImage('${src}')"></div>
        `).join('');
    }
    
    $('pageChatGallery').classList.add('active');
};

window.viewImage = (src) => {
    // Simple image viewer
    const w = window.open("", "_blank");
    w.document.write(`<img src="${src}" style="max-width:100%;">`);
};

window.editChatPersona = () => {
    const f = getActiveFriend();
    if(f) { openFriendEditor(false, f.id); } else { alert("无法获取当前好友信息"); }
};

window.editChatName = () => {
    const f = getActiveFriend();
    if(!f) return;
    const newName = prompt("修改好友备注/聊天昵称", f.name);
    if(newName && newName.trim() !== "") {
        f.name = newName.trim();
        save();
        render(); // Update lists
        renderChatSettings(); // Update settings page
        $('chatTitle').innerText = f.name; // Update chat header
        if(curProfileId === f.id) {
            $('pfName').innerText = f.name;
        }
    }
};

// SUB PAGE LOGIC
let currentScheduleDate = new Date().toISOString().split('T')[0];

window.openSchedulePage = () => {
    const f = getActiveFriend();
    if(!f) return;
    if(!f.createdAt) { f.createdAt = new Date().toISOString().split('T')[0]; save(); }
    renderDailySchedule(f, currentScheduleDate);
    $('pageSchedule').classList.add('active');
};

window.onScheduleDateChange = (date) => {
    currentScheduleDate = date;
    const f = getActiveFriend();
    if(f) renderDailySchedule(f, date);
};

window.openAnniversaryPage = () => {
    const f = getActiveFriend();
    if(f && (!f.anniversaries || f.anniversaries.length === 0)) { autoGenerateAnniversaries(f); }
    renderFullCalendar(currentCalYear, currentCalMonth);
    $('pageAnniversary').classList.add('active');
};

window.closeSubPage = (id) => $(id).classList.remove('active');

function getOrGenerateDaily(f, dateStr) {
    if(!f.dailySchedules) f.dailySchedules = {};
    if(!f.dailySchedules[dateStr]) {
        const tasks = [
            "在阳光明媚的早晨醒来，准备迎接新的一天", "去楼下的面包店买刚出炉的牛角包和美式咖啡", 
            "前往市中心参加关于魔法与科技的研讨会", "在图书馆查阅关于古代符文的资料", 
            "和朋友在公园散步，讨论最近的趣事", "去超市采购新鲜食材，准备晚餐", 
            "在家整理书架，重读喜欢的经典小说", "练习新的魔法咒语，虽然失败了几次但很有趣", 
            "在阳台上看日落，享受片刻的宁静", "写日记记录今天发生的美好瞬间", "给远方的朋友写信，贴上好看的邮票"
        ];
        const daySchedule = [];
        const count = 4 + Math.floor(Math.random() * 3);
        const startHour = 8;
        for(let i=0; i<count; i++) {
            const h = startHour + (i*3) + Math.floor(Math.random()*2);
            const m = Math.floor(Math.random()*4) * 15;
            const time = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
            const task = tasks[Math.floor(Math.random() * tasks.length)];
            daySchedule.push({ time, task });
        }
        f.dailySchedules[dateStr] = daySchedule;
        save();
    }
    return f.dailySchedules[dateStr];
}

function renderDailySchedule(f, dateStr) {
    const list = getOrGenerateDaily(f, dateStr);
    const d = new Date(dateStr);
    const dateDisplay = `${d.getFullYear()}.${(d.getMonth()+1).toString().padStart(2,'0')}.${d.getDate().toString().padStart(2,'0')}`;
    const html = `
        <div class="sch-nav">
            <button onclick="changeScheduleDay(-1)" class="sch-nav-btn">‹</button>
            <span class="sch-nav-date">${dateDisplay}</span>
            <button onclick="changeScheduleDay(1)" class="sch-nav-btn">›</button>
        </div>
        <div class="timeline-list">
            ${list.map(s => `
                <div class="timeline-item">
                    <div class="timeline-date">${s.time}</div>
                    <div class="timeline-title">${s.task}</div>
                </div>
            `).join('')}
        </div>
    `;
    $('fullScheduleList').innerHTML = html;
}

window.changeScheduleDay = (delta) => {
    const f = getActiveFriend();
    if(!f) return;
    const d = new Date(currentScheduleDate);
    d.setDate(d.getDate() + delta);
    const newDateStr = d.toISOString().split('T')[0];
    const todayStr = new Date().toISOString().split('T')[0];
    const createdStr = f.createdAt || '2020-01-01';
    if (newDateStr > todayStr) { alert("不能查看未来的行程哦"); return; }
    if (newDateStr < createdStr) { alert("这是我们相遇之前的日子..."); return; }
    currentScheduleDate = newDateStr;
    renderDailySchedule(f, currentScheduleDate);
};

window.autoGenerateAnniversaries = (f) => {
    if(!f.anniversaries) f.anniversaries = [];
    const today = new Date();
    f.anniversaries.push({ date: today.getFullYear()+'-05-20', title: '相识纪念日' });
    save();
};

window.changeFullMonth = (delta) => {
    currentCalMonth += delta;
    if(currentCalMonth > 11) { currentCalMonth = 0; currentCalYear++; }
    else if(currentCalMonth < 0) { currentCalMonth = 11; currentCalYear--; }
    renderFullCalendar(currentCalYear, currentCalMonth);
};

function renderFullCalendar(year, month) {
    const monthNames = ["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];
    $('fullCalTitle').innerText = `${year}年 ${monthNames[month]}`;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const f = getActiveFriend();
    const anns = f ? (f.anniversaries || []) : [];
    const activeDays = new Set();
    const monthAnns = [];
    anns.forEach(s => {
        const d = new Date(s.date);
        if(d.getMonth() === month) {
            activeDays.add(d.getDate());
            monthAnns.push(s);
        }
    });
    let html = '';
    for(let i=0; i<firstDay; i++) html += `<div></div>`;
    for(let i=1; i<=daysInMonth; i++) {
        const isActive = activeDays.has(i);
        html += `<div class="cal-day ${isActive ? 'active' : ''}">${i}</div>`;
    }
    $('fullCalGrid').innerHTML = html;
    const giftIcon = '<svg class="icon" style="width:24px;height:24px;stroke:#333;stroke-width:1.5;" viewBox="0 0 24 24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>';
    $('monthAnniversaries').innerHTML = monthAnns.length ? monthAnns.map(a => `
        <div class="ann-item">
            <div class="ann-icon" style="background:transparent;border:1px solid #ddd;">${giftIcon}</div>
            <div class="ann-info">
                <div class="ann-title">${a.title}</div>
                <div class="ann-date">${a.date}</div>
            </div>
        </div>
    `).join('') : '<div style="text-align:center;color:#999;padding:20px;">本月无纪念日</div>';
}

window.searchChatHistory = () => {
    $('chatHistorySearchInput').value = '';
    $('chatSearchResults').innerHTML = '';
    $('pageSearchHistory').classList.add('active');
    setTimeout(() => $('chatHistorySearchInput').focus(), 300);
};

window.jumpToMessage = (msgId) => {
    closeSubPage('pageSearchHistory');
    $('chatSettingsPage').classList.remove('active'); // Close settings drawer

    // Delay to allow drawer closing animation
    setTimeout(() => {
        const el = $(`msg-${msgId}`);
        if(el) {
            el.scrollIntoView({behavior: 'smooth', block: 'center'});
            const bubble = el.querySelector('.msg-bubble');
            if(bubble) {
                const originalTransform = bubble.style.transform;
                const originalTransition = bubble.style.transition;
                
                bubble.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
                bubble.style.transform = 'scale(1.05)';
                bubble.style.boxShadow = '0 0 15px rgba(254, 229, 0, 0.6)'; // Yellowish glow
                
                setTimeout(() => {
                    bubble.style.transform = originalTransform;
                    bubble.style.boxShadow = '';
                    setTimeout(() => {
                         bubble.style.transition = originalTransition;
                    }, 300);
                }, 800);
            }
        }
    }, 300);
};

window.performChatSearch = (kw) => {
    const container = $('chatSearchResults');
    if (!kw || kw.trim() === '') {
        container.innerHTML = '';
        return;
    }
    
    const c = state.chats.find(x => x.id === activeChatId);
    if (!c) return;

    const matches = c.messages.filter(m => m.text && m.text.toLowerCase().includes(kw.toLowerCase()));
    
    if (matches.length === 0) {
        container.innerHTML = `<div style="padding:20px;text-align:center;color:#999;font-size:14px;">无搜索结果</div>`;
    } else {
        container.innerHTML = matches.map(m => {
            const d = new Date(m.time);
            const dateStr = `${d.getFullYear()}.${(d.getMonth()+1).toString().padStart(2,'0')}.${d.getDate().toString().padStart(2,'0')}`;
            // const timeStr = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let senderName = 'Unknown';
            let senderAvatar = '';
            
            if (m.sender === 'me') {
                senderName = state.user.name;
                senderAvatar = state.user.avatar;
            } else {
                const f = state.friends.find(x => x.id === m.sender);
                if (f) {
                    senderName = f.name;
                    senderAvatar = f.avatar;
                }
            }

            // Highlight keyword
            const regex = new RegExp(`(${kw})`, 'gi');
            const highlightedText = m.text.replace(regex, '<span style="background:#fee500;">$1</span>');

            return `
                <div style="padding:12px 15px; border-bottom:1px solid #f0f0f0; display:flex; gap:10px; cursor:pointer; background:#fff;" onclick="jumpToMessage('${m.id}')">
                    <img src="${senderAvatar}" style="width:36px; height:36px; border-radius:14px; object-fit:cover;">
                    <div style="flex:1; overflow:hidden;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span style="font-weight:600; font-size:14px; color:#000;">${senderName}</span>
                            <span style="font-size:11px; color:#999;">${dateStr}</span>
                        </div>
                        <div style="font-size:13px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                            ${highlightedText}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
};

window.toggleBlock = (checked) => {
    const f = getActiveFriend();
    if(!f) return;
    f.blocked = checked;
    save();
    const c = state.chats.find(x=>x.id===activeChatId);
    $('chatMsgs').innerHTML = '';
    c.messages.forEach(m => renderMsg(m, f));
};

window.clearChatHistory = () => {
    if(confirm("确定要清空聊天记录吗？")) {
        const c = state.chats.find(x=>x.id===activeChatId);
        if(c) {
            c.messages = [];
            c.lastMessage = '';
            save();
            $('chatMsgs').innerHTML = '';
        }
    }
};

window.deleteContactFromChat = () => {
    if(confirm("确定要删除该联系人吗？聊天记录也将被删除。")) {
        const f = getActiveFriend();
        if(f) {
            state.friends = state.friends.filter(x=>x.id!==f.id);
            state.chats = state.chats.filter(c=>c.targetId!==f.id);
            save();
            toggleChatDrawer();
            closeChat();
            render();
        }
    }
};

window.closeModal = id => $(id).classList.remove('active');
window.closeChat = () => $('chatRoom').classList.remove('active');
window.toggleChatExtra = () => $('chatExtra').classList.toggle('open');

window.openWallet = () => {
    $('walletBalanceDisplay').innerText = `¥ ${state.wallet.balance.toFixed(2)}`;
    $('viewWallet').classList.add('active');
};

window.openSettings = () => $('modalSettings').classList.add('active');

// WALLET AND TRANSACTIONS LOGIC
const addTransaction = (type, amount, description) => {
    if (!state.wallet.transactions) {
        state.wallet.transactions = [];
    }
    const transaction = {
        id: 't' + Date.now(),
        type, // 'recharge', 'transfer', 'purchase'
        amount, // a positive number
        description,
        date: new Date().toISOString()
    };
    state.wallet.transactions.unshift(transaction); // Add to the beginning
    save();
};

window.rechargeWallet = () => {
    const amount = 2000;
    state.wallet.balance += amount;
    addTransaction('recharge', amount, '钱包充值');
    $('walletBalanceDisplay').innerText = `¥ ${state.wallet.balance.toFixed(2)}`;
    // alert(`成功充值 ¥${amount}`);
};

window.openTransactions = () => {
    const listEl = $('transactionList');
    const transactions = state.wallet.transactions || [];
    if (transactions.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;color:#999;padding:40px 0;">暂无账单记录</div>';
    } else {
        listEl.innerHTML = transactions.map(t => {
            const isIncome = t.type === 'recharge';
            const d = new Date(t.date);
            const dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
            return `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-desc">${t.description}</div>
                        <div class="transaction-date">${dateStr}</div>
                    </div>
                    <div class="transaction-amount ${isIncome ? 'income' : 'expense'}">
                        ${isIncome ? '+' : '-'}${t.amount.toFixed(2)}
                    </div>
                </div>
            `;
        }).join('');
    }
    $('pageTransactions').classList.add('active');
};


window.handleChatImage = (input) => {
    if(input.files && input.files[0]) {
        const r = new FileReader();
        r.onload = v => {
            sendMsg({ type:'image', image: v.target.result });
            toggleChatExtra();
        };
        r.readAsDataURL(input.files[0]);
    }
};

let cameraStream = null;
window.openCamera = async () => {
    const v = $('cameraVideo');
    $('modalCamera').classList.add('active');
    toggleChatExtra();
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        v.srcObject = cameraStream;
    } catch(e) {
        alert("无法访问摄像头: " + e.message);
        closeModal('modalCamera');
    }
};

window.stopCamera = () => {
    if(cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
    }
};

window.takePhoto = () => {
    const v = $('cameraVideo');
    const c = $('cameraCanvas');
    if(v.srcObject) {
        c.width = v.videoWidth;
        c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        const data = c.toDataURL('image/jpeg');
        sendMsg({ type:'image', image: data });
        stopCamera();
        closeModal('modalCamera');
    }
};

window.openTransfer = () => {
    const f = getActiveFriend();
    if(!f) return;
    $('transferAvatar').src = f.avatar;
    $('transferName').innerText = f.name;
    $('walletBalance').innerText = state.wallet.balance;
    $('transferAmount').value = '';
    $('modalTransfer').classList.add('active');
    toggleChatExtra();
};

window.confirmTransfer = () => {
    const amt = parseInt($('transferAmount').value);
    if(!amt || amt <= 0) return alert("请输入有效金额");
    if(amt > state.wallet.balance) return alert("余额不足");
    
    const friend = getActiveFriend();
    const description = `转账给 ${friend ? friend.name : '好友'}`;

    state.wallet.balance -= amt;
    addTransaction('transfer', amt, description);

    sendMsg({ type:'transfer', amount: amt });
    closeModal('modalTransfer');
    alert(`转账 ¥${amt} 成功`);
};

window.openLocation = () => {
    $('modalLocation').classList.add('active');
    toggleChatExtra();
};

window.selectLocation = (loc) => {
    sendMsg({ type:'location', address: loc });
    closeModal('modalLocation');
};


window.checkGiftTrigger = (text, friendId) => {
    const keywords = {
        '咖啡': '星巴克咖啡', '拿铁': '星巴克咖啡', '星巴克': '星巴克咖啡', '好渴': '星巴克咖啡',
        '蛋糕': '草莓蛋糕', '甜点': '草莓蛋糕', '生日': '草莓蛋糕',
        '饿了': '炸鸡套餐', '炸鸡': '炸鸡套餐', '晚餐': '炸鸡套餐', '午餐': '炸鸡套餐',
        '花': '鲜花束', '浪漫': '鲜花束', '爱你': '鲜花束', '喜欢你': '鲜花束',
        '电影': '电影票', '看戏': '电影票', '无聊': '电影票',
        '累了': '香薰蜡烛', '休息': '香薰蜡烛', '香薰': '香薰蜡烛', '睡觉': '香薰蜡烛'
    };

    let matchedGift = null;
    for (let key in keywords) {
        if (text.includes(key)) {
            matchedGift = keywords[key];
            break;
        }
    }

    if (matchedGift) {
        // 模拟对方看到消息并回复的延迟 (2-5秒)
        const delay = 2000 + Math.random() * 3000;
        setTimeout(() => {
            window.receiveGiftFromContact(friendId, matchedGift);
        }, delay);
    }
};

window.receiveGiftFromContact = (friendId, giftName) => {
    let f;
    if(friendId) {
         f = state.friends.find(x=>x.id === friendId);
    } 
    if(!f && state.friends.length > 0) {
        f = state.friends[Math.floor(Math.random() * state.friends.length)];
    }
    if(!f) return;
    
    let p;
    if(giftName) {
        p = products.find(x=>x.name === giftName);
    }
    if(!p) {
         p = products[Math.floor(Math.random() * products.length)];
    }
    
    let chat = state.chats.find(c => c.targetId === f.id);
    if (!chat) {
        chat = { id: Date.now().toString(), targetId: f.id, messages: [], lastMessage: '', lastTime: Date.now() };
        state.chats.unshift(chat);
    }
    
    const msg = {
        id: Date.now(),
        sender: 'them',
        text: `[礼物] ${p.name}`,
        type: 'gift',
        content: p.name,
        image: p.image,
        time: new Date().toLocaleTimeString('en-US', {hour12:false, hour:'2-digit', minute:'2-digit'})
    };
    
    chat.messages.push(msg);
    chat.lastMessage = `[礼物] ${p.name}`;
    chat.lastTime = Date.now();
    
    // 将聊天移到顶部
    state.chats = state.chats.filter(c => c.id !== chat.id);
    state.chats.unshift(chat);
    save();
    
    // 如果当前正在与该好友聊天，实时渲染消息
    if (activeChatId === chat.id) {
        renderMsg(msg, f);
    } else {
        // 可选：显示未读提示或 toast，但这里暂不处理
    }
    
    render(); // 更新聊天列表显示的最后一条消息
};


// GROUP CHAT CREATION LOGIC
let tempSelectedMembers = new Set();

window.openProfileEdit = (id) => {
    const user = id === 'me' ? state.user : state.friends.find(f=>f.id===id);
    if(!user) return;
    
    // Set values
    $('pfeAvatar').src = user.avatar;
    $('pfeName').value = user.name;
    $('pfeStatus').value = user.status || '';
    
    // Set background
    const bg = user.bgImage || '#849bca';
    const mp = $('modalProfileEdit');
    mp.style.backgroundImage = bg.startsWith('http') || bg.startsWith('data:') ? `url(${bg})` : 'none';
    mp.style.backgroundColor = bg.startsWith('http') || bg.startsWith('data:') ? 'transparent' : bg;
    
    mp.classList.add('active');
    
    // Store editing id
    mp.dataset.eid = id;
    
    // Reset temp variables
    window.tempEditAvatar = null;
    window.tempEditBg = null;
};

window.closeProfileEdit = () => {
    $('modalProfileEdit').classList.remove('active');
};

window.saveProfileEdit = () => {
    const mp = $('modalProfileEdit');
    const id = mp.dataset.eid;
    const user = id === 'me' ? state.user : state.friends.find(f=>f.id===id);
    
    if(user) {
        user.name = $('pfeName').value;
        user.status = $('pfeStatus').value;
        if(window.tempEditAvatar) user.avatar = window.tempEditAvatar;
        if(window.tempEditBg) user.bgImage = window.tempEditBg;
        save();
    }
    
    closeProfileEdit();
    openProfile(id); // Refresh profile view
};

window.handlePfeFile = (input, type) => {
    if(input.files[0]) {
        const r = new FileReader();
        r.onload = v => {
            if(type === 'avatar') {
                $('pfeAvatar').src = v.target.result;
                window.tempEditAvatar = v.target.result;
            } else if(type === 'bg') {
                const mp = $('modalProfileEdit');
                mp.style.backgroundImage = `url(${v.target.result})`;
                window.tempEditBg = v.target.result;
            }
        };
        r.readAsDataURL(input.files[0]);
    }
    input.value = '';
};

window.openCreateGroupPage = () => {
    tempSelectedMembers.clear();
    const container = $('createGroupFriendList');
    if(!container) return;

    // Render friend list with checkboxes
    // Sort friends by name
    const sortedFriends = [...state.friends].sort((a,b) => a.name.localeCompare(b.name, 'zh-CN'));
    
    if (sortedFriends.length === 0) {
        container.innerHTML = `<div style="text-align:center;padding:20px;color:#999;">暂无好友可邀请</div>`;
    } else {
        container.innerHTML = sortedFriends.map(f => `
            <div class="profile-item" onclick="toggleGroupSelect('${f.id}')" style="cursor:pointer;">
                <img class="avatar" src="${f.avatar}">
                <div class="profile-info">
                    <div class="profile-name">${f.name}</div>
                </div>
                <div id="gc-check-${f.id}" class="checkbox-circle"></div>
            </div>
        `).join('');
    }
    
    // Reset inputs
    $('createGroupName').value = '';
    updateCreateGroupBtn();
    
    $('pageCreateGroup').classList.add('active');
};

window.toggleGroupSelect = (fid) => {
    if(tempSelectedMembers.has(fid)) {
        tempSelectedMembers.delete(fid);
        $(`gc-check-${fid}`).classList.remove('checked');
        $(`gc-check-${fid}`).innerText = '';
    } else {
        tempSelectedMembers.add(fid);
        $(`gc-check-${fid}`).classList.add('checked');
        $(`gc-check-${fid}`).innerText = '✓';
    }
    updateCreateGroupBtn();
};

function updateCreateGroupBtn() {
    const count = tempSelectedMembers.size;
    const btn = $('createGroupBtn');
    if(btn) {
        btn.innerText = `创建(${count})`;
        btn.style.color = count > 0 ? '#000' : '#ccc';
    }
}

window.createGroupChat = () => {
    if(tempSelectedMembers.size === 0) {
        alert("请至少选择一位好友");
        return;
    }
    
    const nameInput = $('createGroupName').value.trim();
    const memberIds = Array.from(tempSelectedMembers);
    
    const newChat = {
        id: 'g' + Date.now(),
        isGroup: true,
        name: nameInput, // Can be empty, logic handles empty name display
        members: memberIds,
        messages: [],
        lastMessage: '群聊已创建',
        lastTime: Date.now()
    };
    
    state.chats.unshift(newChat);
    save();
    
    closeSubPage('pageCreateGroup');
    render(); // Update chat list in main view
    openChat(newChat.id);
};

window.leaveGroup = () => {
    if(!confirm("确定要退出群聊吗？")) return;
    state.chats = state.chats.filter(c => c.id !== activeChatId);
    save();
    toggleChatDrawer(); // Close settings
    closeChat(); // Close chat room
    render(); // Update list
};

// AI Implementation
function checkAndScheduleAI(chatId) {
    const chat = state.chats.find(c => c.id === chatId);
    if (!chat) return;
    const lastMsg = chat.messages[chat.messages.length - 1];
    if (lastMsg && lastMsg.sender === 'me') {
        const friend = state.friends.find(f => f.id === chat.targetId);
        if (friend && !chat.isGroup) {
            triggerAIResponse(chatId, friend);
        }
    }
}

function getGlobalApiConfig() {
    try {
        const configs = JSON.parse(localStorage.getItem('api-configs') || '[]');
        const defaultConfig = configs.find(c => c.isDefault) || configs[0];
        const globalSettings = JSON.parse(localStorage.getItem('api-global-settings') || '{}');
        const thinkingConfig = JSON.parse(localStorage.getItem('thinking-model-settings') || '{}');
        
        return {
            config: defaultConfig,
            settings: globalSettings,
            thinking: thinkingConfig
        };
    } catch (e) {
        console.error("Error reading global config", e);
        return { config: null, settings: {}, thinking: {} };
    }
}

function updateGlobalConfigStatus() {
    const statusEl = $('globalConfigStatus');
    if(!statusEl) return;
    
    const { config } = getGlobalApiConfig();
    if(config && config.url && config.key) {
        statusEl.innerHTML = `✅ 已连接: <strong>${config.name}</strong><br><span style="color:#999;font-size:11px;">${config.model || '默认模型'}</span>`;
    } else {
        statusEl.innerHTML = `❌ 未检测到有效配置<br><span style="color:#999;font-size:11px;">请前往设置应用添加 API</span>`;
    }
}

async function triggerAIResponse(chatId, friend) {
    // 防抖：清除之前的定时器
    if (aiReplyTimers[chatId]) {
        clearTimeout(aiReplyTimers[chatId]);
    }

    // 延迟 1.5 秒后执行 (模拟阅读思考时间)
    aiReplyTimers[chatId] = setTimeout(async () => {
        delete aiReplyTimers[chatId];
        
        const chat = state.chats.find(c => c.id === chatId);
        if (!chat) return;

        // 再次检查输入框是否有内容（防止用户正在输入时AI突然回复）
        const inputVal = $('chatInput').value;
        if (inputVal && inputVal.trim().length > 0) {
            return;
        }

        // 获取全局配置
        const { config, settings, thinking } = getGlobalApiConfig();
        
        if (!config || !config.url || !config.key) {
            console.warn("[AI] 未配置全局 API 信息");
            return;
        }

        // 显示正在输入动画 (Typing Indicator)
        let typingElId = null;
        if (activeChatId === chatId) {
            const chatContainer = $('chatMsgs');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingElId = 'ai-typing-' + Date.now();
            typingIndicator.id = typingElId;
            typingIndicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            typingIndicator.style.display = 'flex';
            chatContainer.appendChild(typingIndicator);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 辅助函数：移除输入指示器
        const removeTypingIndicator = () => {
            if (typingElId) {
                const el = document.getElementById(typingElId);
                if (el) el.remove();
            }
        };

        // 辅助函数：将我的未读消息标记为已读
        const markMyMessagesAsRead = () => {
            // 1. 更新数据模型
            let updated = false;
            chat.messages.forEach(m => {
                if (m.sender === 'me' && m.unread !== false) {
                    m.unread = false;
                    updated = true;
                }
            });
            if (updated) save();

            // 2. 更新 DOM (如果当前在聊天界面)
            if (activeChatId === chatId) {
                const unreadBadges = document.querySelectorAll('#chatMsgs .msg-row.mine .msg-unread');
                unreadBadges.forEach(el => el.remove());
            }
        };

        // 1. 准备上下文
        const historyLimit = parseInt(settings.memoryCount) || 10;
        // 获取最近的消息并转换格式
        const recentMessages = chat.messages.slice(-historyLimit).map(m => {
            let content = m.text;
            if (m.type === 'image') content = '[图片]';
            else if (m.type === 'gift') content = `[收到礼物: ${m.content}]`;
            else if (m.type === 'transfer') content = `[收到转账: ${m.amount}]`;
            
            return {
                role: m.sender === 'me' ? 'user' : 'assistant',
                content: content || '...'
            };
        });

        // 2. 准备世界观和人设
        let worldSetting = "";
        if (friend.worldviewId) {
            const world = state.worldbooks.find(w => w.id === friend.worldviewId);
            if (world) {
                worldSetting = `\n[当前世界观/背景设定]\n标题: ${world.title}\n内容: ${world.content}\n`;
            }
        }

        const systemPrompt = `你现在正在进行角色扮演。请完全沉浸在以下角色中与用户对话。

[你的角色设定]
名字: ${friend.name}
${friend.persona ? `人设/性格: ${friend.persona}` : "性格: 像普通朋友一样聊天。"}
${friend.status ? `当前状态/签名: ${friend.status}` : ""}
${friend.relation ? `与用户的关系: ${friend.relation}` : ""}
${worldSetting}

[对话要求]
1. 必须以 "${friend.name}" 的身份回复，严禁暴露你是 AI 或语言模型。
2. 回复风格必须像即时通讯软件(KakaoTalk)的聊天消息：简短、口语化、自然。
3. 避免长篇大论，除非话题需要。可以适当使用emoji。
4. 记住你和用户的关系以及当前的世界观背景。
`;

        const messages = [
            { role: 'system', content: systemPrompt },
            ...recentMessages
        ];

        // 3. 调用 API
        try {
            let apiUrl = (config.url || '').replace(/\/$/, '');
            let apiKey = config.key;
            let model = config.model || 'gpt-3.5-turbo';
            let temperature = parseFloat(settings.temperature) || 0.7;
            let isThinkingModel = false;

            // 检查是否有“思考模型”配置
            if (thinking && thinking.thinking_endpoint && thinking.thinking_api_key) {
                console.log("[AI] 切换至思考模型配置");
                apiUrl = thinking.thinking_endpoint.replace(/\/$/, '');
                apiKey = thinking.thinking_api_key;
                if (thinking.thinking_model_name) {
                    model = thinking.thinking_model_name;
                }
                isThinkingModel = true;
            }

            const requestBody = {
                model: model,
                messages: messages
            };

            // 只有非推理模型或者是支持 temp 的模型才加 temperature
            requestBody.temperature = temperature;

            const response = await fetch(`${apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                console.error("AI API Error:", response.status, await response.text());
                removeTypingIndicator();
                return;
            }

            const data = await response.json();
            const messageObj = data.choices[0].message;
            const aiText = messageObj.content;
            const reasoningContent = messageObj.reasoning_content || null; // 捕获推理过程(DeepSeek R1等)

            if (aiText || reasoningContent) {
                // 如果只有推理内容没有正文(极端情况)，暂且不显示，或者显示“思考完毕”
                const displayText = aiText || "(思考完毕，但未生成回复)";

                // 模拟回复延迟 (每字符50ms, 最少1s, 最多5s)
                // 如果是思考模型，可能已经花了很多时间，延迟可以短一点
                const delayBase = isThinkingModel ? 500 : 1000;
                const delay = Math.min(5000, delayBase + displayText.length * 50);

                setTimeout(() => {
                    removeTypingIndicator(); // 移除动画
                    markMyMessagesAsRead();  // 标记已读

                    const newMsg = {
                        id: Date.now(),
                        sender: friend.id,
                        text: displayText,
                        time: Date.now()
                    };

                    // 保存推理内容以备后用
                    if (reasoningContent) {
                        newMsg.reasoning = reasoningContent;
                        console.log(`[AI Thinking] ${friend.name} 的思考过程:\n`, reasoningContent);
                    }

                    chat.messages.push(newMsg);
                    chat.lastMessage = displayText;
                    chat.lastTime = Date.now();
                    
                    // 置顶聊天
                    state.chats = state.chats.filter(c => c.id !== chat.id);
                    state.chats.unshift(chat);
                    save();

                    // 如果当前正在查看此聊天，渲染消息
                    if (activeChatId === chatId) {
                        renderMsg(newMsg, friend);
                    } else {
                        render(); // 更新列表预览
                    }
                }, delay);
            } else {
                removeTypingIndicator();
            }

        } catch (e) {
            console.error("AI Trigger Failed:", e);
            removeTypingIndicator();
        }
    }, 1500); // end setTimeout
}

// Voice Clone Logic
window.handleVoiceUpload = (input) => {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            alert("文件大小超过 10MB 限制，请重新选择。");
            input.value = ''; // Clear selection
            return;
        }
        // Ideally we would save this file or its reference here
    }
};

window.previewVoiceClone = () => {
    const text = document.getElementById('voicePreviewText').value;
    if (!text.trim()) {
        alert("请输入要试听的文本");
        return;
    }
    
    const btn = document.getElementById('btnPreviewVoice');
    const status = document.getElementById('voicePreviewStatus');
    
    // Reset if it was in 'Play' state
    if (btn.innerText.includes('播放')) {
        alert(`正在播放: "${text}"\n(这是演示功能，未连接真实TTS引擎)`);
        return;
    }

    btn.disabled = true;
    btn.style.opacity = '0.7';
    btn.innerText = '正在合成...';
    
    status.style.display = 'block';
    status.innerText = 'AI 正在学习声纹特征...';
    
    // Simulate API delay
    setTimeout(() => {
        status.innerText = '正在生成语音...';
        setTimeout(() => {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.innerText = '▶️ 播放试听';
            status.innerText = '合成完成！(模拟播放)';
        }, 1500);
    }, 1500);
};

// --- RED PACKET LOGIC ---
let currentRedPacketId = null;

window.openRedPacket = () => {
    // Sending logic
    const amountStr = prompt("请输入红包金额:", "88");
    if (amountStr === null) return;
    const amount = parseFloat(amountStr);
    if (isNaN(amount) || amount <= 0) {
        alert("请输入有效的金额");
        return;
    }
    if (state.wallet.balance < amount) {
        alert("余额不足");
        return;
    }

    const text = prompt("请输入祝福语:", "恭喜发财，大吉大利");
    if (text === null) return; // Cancelled

    // Deduct balance
    state.wallet.balance -= amount;
    addTransaction('redpacket_send', amount, `发出红包`);
    $('walletBalanceDisplay').innerText = `¥ ${state.wallet.balance.toFixed(2)}`;

    // Send Message
    const msg = { 
        type: 'redpacket', 
        amount: amount, 
        content: text || "恭喜发财，大吉大利",
        status: 'unclaimed' // unclaimed, claimed
    };
    sendMsg(msg);
    toggleChatExtra();
};

window.viewRedPacket = (msgId) => {
    const chat = state.chats.find(c => c.id === activeChatId);
    if (!chat) return;
    const msg = chat.messages.find(m => m.id == msgId);
    if (!msg) return;

    currentRedPacketId = msgId;
    
    // Set UI
    const sender = msg.sender === 'me' ? state.user : state.friends.find(f => f.id === msg.sender);
    $('rpAvatar').src = sender ? sender.avatar : 'default_avatar.png';
    $('rpName').innerText = sender ? sender.name : 'Unknown';
    $('rpMsg').innerText = msg.content;

    // Check status
    const btn = document.querySelector('.rp-btn-open');
    if (msg.status === 'claimed') {
        btn.innerText = "已领";
        btn.style.background = "#fff";
        btn.style.fontSize = "16px";
    } else {
        btn.innerText = "開";
        btn.style.background = "#fceea8";
        btn.style.fontSize = "24px";
    }

    $('modalRedPacket').style.display = 'flex';
};

window.closeRedPacket = () => {
    $('modalRedPacket').style.display = 'none';
    currentRedPacketId = null;
};

window.openRedPacketAction = () => {
    if (!currentRedPacketId) return;
    
    const chat = state.chats.find(c => c.id === activeChatId);
    if (!chat) return;
    const msg = chat.messages.find(m => m.id == currentRedPacketId);
    if (!msg) return;

    if (msg.status === 'claimed') {
        // Already claimed details
        alert(`你已经领取过了，金额: ¥${msg.amount.toFixed(2)}`);
        return;
    }

    // Claim logic
    // Add animation or delay here if desired
    const btn = document.querySelector('.rp-btn-open');
    btn.style.transform = "rotateY(360deg)";
    btn.style.transition = "transform 0.6s";

    setTimeout(() => {
        msg.status = 'claimed';
        state.wallet.balance += msg.amount;
        addTransaction('redpacket_receive', msg.amount, `收到红包`);
        $('walletBalanceDisplay').innerText = `¥ ${state.wallet.balance.toFixed(2)}`;
        save();
        
        btn.innerText = "已领";
        btn.style.background = "#fff";
        btn.style.fontSize = "16px";
        btn.style.transform = "none";
        
        alert(`领取成功！\n金额: ¥${msg.amount.toFixed(2)}`);
    }, 600);
};

// --- CALL LOGIC ---
let callTimerInterval = null;

window.startVoiceCall = () => {
    initCall('语音通话');
};

window.startVideoCall = () => {
    initCall('视频通话');
};

function initCall(type) {
    const f = getActiveFriend();
    if (!f) return;

    $('callAvatar').src = f.avatar;
    $('callName').innerText = f.name;
    $('callStatus').innerText = `${type}呼叫中...`;
    $('callTimer').style.opacity = '0';
    $('callTimer').innerText = "00:00";
    
    $('modalCall').style.display = 'flex';
    toggleChatExtra(); // close menu

    // Simulate connection
    setTimeout(() => {
        $('callStatus').innerText = "通话中";
        $('callTimer').style.opacity = '1';
        startCallTimer();
    }, 2000);
}

function startCallTimer() {
    let seconds = 0;
    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        $('callTimer').innerText = `${m}:${s}`;
    }, 1000);
}

window.endCall = () => {
    if (callTimerInterval) clearInterval(callTimerInterval);
    $('modalCall').style.display = 'none';
    
    // Add system message
    const c = state.chats.find(x => x.id === activeChatId);
    if (c) {
        const duration = $('callTimer').innerText;
        const msg = {
            sender: 'me',
            text: `[通话结束] 时长 ${duration}`,
            time: Date.now()
        };
        c.messages.push(msg);
        c.lastMessage = `[通话] ${duration}`;
        save();
        if(typeof renderMsg === 'function') renderMsg(msg, getActiveFriend());
    }
};

window.toggleMute = () => {
    const btns = document.querySelectorAll('.call-btn.mute');
    // Just visual feedback
    btns[0].style.backgroundColor = btns[0].style.backgroundColor === 'white' ? 'rgba(255,255,255,0.2)' : 'white';
    btns[0].style.color = btns[0].style.backgroundColor === 'white' ? '#000' : '#fff';
};

window.toggleSpeaker = () => {
    const btns = document.querySelectorAll('.call-btn.mute');
    // Just visual feedback
    btns[1].style.backgroundColor = btns[1].style.backgroundColor === 'white' ? 'rgba(255,255,255,0.2)' : 'white';
    btns[1].style.color = btns[1].style.backgroundColor === 'white' ? '#000' : '#fff';
};

// --- EMOTICON LOGIC ---
let activeEmojiTab = 'ryan';

window.openEmoticonShop = () => {
    renderEmoticonShop();
    $('pageEmoticonShop').classList.add('active');
};

window.renderEmoticonShop = () => {
    const list = $('emoticonShopList');
    if (!list) return;

    list.innerHTML = emoticonPacks.map(pack => {
        const hasOwned = state.emoticons.includes(pack.id);
        return `
            <div class="emo-pack-item">
                <div class="emo-pack-img"><img src="${pack.thumb}" style="width:40px;height:40px;"></div>
                <div class="emo-pack-info">
                    <div class="emo-pack-title">${pack.name}</div>
                    <div class="emo-pack-desc">${pack.desc}</div>
                </div>
                <div class="emo-btn-get ${hasOwned ? 'downloaded' : 'active'}" 
                     onclick="downloadEmoticonPack('${pack.id}')">
                     ${hasOwned ? '已拥有' : '下载'}
                </div>
            </div>
        `;
    }).join('');
};

window.downloadEmoticonPack = (packId) => {
    if (state.emoticons.includes(packId)) return;
    state.emoticons.push(packId);
    save();
    renderEmoticonShop();
    renderEmojiPanel(); // Refresh panel if open
    alert('表情包下载成功！');
};

window.toggleEmojiPanel = () => {
    const panel = $('emojiPanel');
    const extra = $('chatExtra');
    
    if (panel.classList.contains('open')) {
        panel.classList.remove('open');
    } else {
        // Close extra if open
        if (extra.classList.contains('open')) extra.classList.remove('open');
        
        renderEmojiPanel();
        panel.classList.add('open');
    }
};

window.renderEmojiPanel = () => {
    const tabsContainer = $('emojiTabs');
    const gridContainer = $('emojiGrid');
    
    // Ensure active tab is valid (owned)
    if (!state.emoticons.includes(activeEmojiTab)) {
        activeEmojiTab = state.emoticons[0] || 'ryan';
    }

    // Render Tabs
    tabsContainer.innerHTML = state.emoticons.map(id => {
        const pack = emoticonPacks.find(p => p.id === id);
        if (!pack) return '';
        return `
            <div class="emoji-tab ${activeEmojiTab === id ? 'active' : ''}" onclick="switchEmojiTab('${id}')">
                <img src="${pack.thumb}">
            </div>
        `;
    }).join('');

    // Render Grid
    const pack = emoticonPacks.find(p => p.id === activeEmojiTab);
    if (pack) {
        gridContainer.innerHTML = pack.items.map(src => `
            <div class="emoji-item" onclick="sendEmoji('${src}')">
                <img src="${src}">
            </div>
        `).join('');
    } else {
        gridContainer.innerHTML = '<div style="padding:20px;color:#999;">无表情</div>';
    }
};

window.switchEmojiTab = (id) => {
    activeEmojiTab = id;
    renderEmojiPanel();
};

window.sendEmoji = (src) => {
    sendMsg({ type: 'image', content: src, image: src });
};

// --- LOCATION LOGIC ---
window.sendCustomLocation = () => {
    const input = $('locationInput');
    const val = input.value.trim();
    if (!val) return alert('请输入位置名称');
    
    sendMsg({ type: 'location', address: val });
    input.value = '';
    closeModal('modalLocation');
};

// --- GROUP AVATAR LOGIC ---
window.handleGroupAvatar = (input) => {
    if (input.files && input.files[0]) {
        const r = new FileReader();
        r.onload = v => {
            const c = state.chats.find(x => x.id === activeChatId);
            if (c) {
                c.avatar = v.target.result;
                save();
                renderChatSettings(); // Refresh settings view
                render(); // Refresh chat list
                alert("群头像已修改");
            }
        };
        r.readAsDataURL(input.files[0]);
    }
    input.value = '';
};
</script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        if(typeof init === 'function') init();
    });

    function autoResizeEmulator() {
        const iphoneBody = document.querySelector('.iphone-body');
        if (!iphoneBody) return;
        const baseWidth = 393 + 12; 
        const baseHeight = 852 + 12; 
        const margin = 40; 
        const availableWidth = window.innerWidth - margin;
        const availableHeight = window.innerHeight - margin;
        const scaleX = availableWidth / baseWidth;
        const scaleY = availableHeight / baseHeight;
        const scale = Math.min(scaleX, scaleY, 1.2); 
        iphoneBody.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', autoResizeEmulator);
    window.addEventListener('load', autoResizeEmulator);
    autoResizeEmulator();
</script>
</body>
</html>
